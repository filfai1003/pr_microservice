<!DOCTYPE html><html><head>
      <title>Microservice</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\sfilf\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.20\crossnote\dependencies\katex\katex.min.css">
      
      
      <script type="text/javascript" src="file:///c:\Users\sfilf\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.20\crossnote\dependencies\mermaid\mermaid.min.js" charset="UTF-8"></script>
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h3 id="à-cause-de-la-conversion-en-pdf-il-y-a-eu-des-coupes-dans-des-parties-de-code-pour-une-lecture-facilitée-nous-recommandons-dutiliser-le-fichier-html">À cause de la conversion en PDF, il y a eu des coupes dans des parties de code. Pour une lecture facilitée, nous recommandons d'utiliser le fichier HTML. </h3>
<h1 id="binv3140--projet-microservices">BINV3140 — Projet Microservices </h1>
<p>Groupe 08</p>
<ul>
<li>Ambrozewski Kornel</li>
<li>Chu Jason</li>
<li>Faiella Filippo</li>
<li>Longheval Louis-Nicolas</li>
</ul>
<h2 id="résumé-exécutif">Résumé Exécutif </h2>
<ul>
<li>But: construire Eventify, une billetterie en microservices.</li>
<li>Principes: DDD, échanges par événements, une base PostgreSQL par service, RabbitMQ, Redis (TTL), OpenSearch pour la recherche.</li>
<li>Cohérence: forte pour stock, check‑in et paiement; ailleurs, Sagas + Outbox.</li>
<li>Sécurité: OAuth2/OIDC; vérification des JWT à la Gateway et dans les services; rôles et scopes simples.</li>
<li>Observabilité: métriques, logs JSON et traces avec <code>x-correlation-id</code>.</li>
<li>Déploiement: Dev (Compose) puis Kubernetes (Staging/Prod); CI/CD avec tests et images signées.</li>
</ul>
<h2 id="analyse-du-domaine--ddd-brouillon">Analyse du Domaine &amp; DDD (Brouillon) </h2>
<h3 id="1-processus-métier-clés">1) Processus métier clés </h3>
<ul>
<li>Créer un événement: Un organisateur définit titre, description, dates/séances, lieu, catégories de prix, capacités. Résultat: l’événement est en état « brouillon ».</li>
<li>Configurer le plan de salle: Définir le seating plan (zones, sièges numérotés ou placement libre), les quotas, catégories tarifaires et règles (ex. accessibilité, bundles).</li>
<li>Publier / Ouvrir les ventes: Passer l’événement en état « publié », ouvrir une ou plusieurs séances à la vente. Déclenche les projections côté catalogue.</li>
<li>Rechercher / Consulter un événement: Un client parcourt le catalogue, filtre par date/lieu, consulte les séances, la disponibilité et les prix.</li>
<li>Réserver une place: Verrouiller temporairement des sièges/quantités pour un client (panier). Délai d’expiration des réservations temporaires.</li>
<li>Payer la commande: Le client règle via un prestataire de paiement. En cas de succès, la commande passe en « payée ».</li>
<li>Émettre le billet: Après paiement, générer billets (QR/Barcodes), les associer aux sièges, envoyer au client.</li>
<li>Annuler réservation/commande: Libérer les sièges si non payée; si payée, déclencher workflow d’annulation et remboursement selon politique.</li>
<li>Rembourser: Effectuer remboursement partiel/total, publier l’événement de remboursement et rétablir disponibilité.</li>
<li>Check-in / Contrôle d’accès: Scanner billets à l’entrée, valider l’authenticité et l’état (utilisé/non utilisé), enregistrer l’accès.</li>
</ul>
<p>Principales règles transverses:</p>
<ul>
<li>Disponibilité en temps réel: cohérence entre réservations et stock de sièges.</li>
<li>Expiration des réservations: libérer automatiquement après délai.</li>
<li>Idempotence et résilience: surtout pour paiement et émission des billets.</li>
<li>Traçabilité: événements de domaine persistés (audit, projections, reporting).</li>
</ul>
<hr>
<h3 id="2-bounded-contexts-ddd">2) Bounded Contexts (DDD) </h3>
<ol>
<li>
<p>Event Management (Planification)</p>
<ul>
<li>Rôle: Créer/éditer événements, séances, tarifs, politiques d’annulation; états brouillon/publié/archivé.</li>
<li>Agrégats: <code>Event</code>, <code>Performance</code> (séance), <code>PricingScheme</code>.</li>
<li>Commandes: CreateEvent, UpdateEvent, PublishEvent, SchedulePerformance.</li>
<li>Événements domaine: EventCreated, EventPublished, PerformanceScheduled, EventUpdated.</li>
</ul>
</li>
<li>
<p>Venue &amp; Seating (Inventory)</p>
<ul>
<li>Rôle: Modéliser salles/plans, sièges, quotas; contrôler le stock (sièges nominatifs ou capacity-based).</li>
<li>Agrégats: <code>Venue</code>, <code>SeatingPlan</code>, <code>Seat</code>, <code>InventoryBucket</code> (placement libre par zone).</li>
<li>Commandes: DefineSeatingPlan, ReserveSeats, ReleaseSeats, AdjustCapacity.</li>
<li>Événements: SeatsReserved, SeatsReleased, CapacityAdjusted.</li>
</ul>
</li>
<li>
<p>Catalogue (Lecture/Recherche)</p>
<ul>
<li>Rôle: Vue orientée lecture pour clients (events, disponibilités, prix), indexée pour recherche.</li>
<li>Modèle: Projections/Read Models alimentés par Event Management &amp; Inventory.</li>
<li>Intégrations: Consomme EventPublished, PerformanceScheduled, CapacityAdjusted.</li>
</ul>
</li>
<li>
<p>Reservation (Panier &amp; Holds)</p>
<ul>
<li>Rôle: Gérer réservations temporaires, paniers, expirations; référencer sièges/quantités.</li>
<li>Agrégats: <code>Reservation</code> (avec items), <code>ReservationHold</code>.</li>
<li>Commandes: StartReservation, AddItem, ConfirmReservation, CancelReservation.</li>
<li>Événements: ReservationStarted, ReservationItemAdded, ReservationExpired, ReservationCancelled.</li>
</ul>
</li>
<li>
<p>Order &amp; Payment</p>
<ul>
<li>Rôle: Transformer une réservation confirmée en commande, encaisser paiements, gérer états (en attente, payé, échoué, remboursé).</li>
<li>Agrégats: <code>Order</code>, <code>Payment</code>.</li>
<li>Commandes: PlaceOrder, CapturePayment, RefundPayment.</li>
<li>Événements: OrderPlaced, PaymentCaptured, PaymentFailed, PaymentRefunded.</li>
</ul>
</li>
<li>
<p>Ticketing &amp; Access Control</p>
<ul>
<li>Rôle: Émettre billets (numériques), gérer statut (valide, annulé, utilisé), contrôler accès sur site.</li>
<li>Agrégats: <code>Ticket</code>, <code>CheckIn</code>.</li>
<li>Commandes: IssueTickets, RevokeTicket, CheckInTicket.</li>
<li>Événements: TicketIssued, TicketRevoked, TicketCheckedIn.</li>
</ul>
</li>
<li>
<p>Customer / Identity</p>
<ul>
<li>Rôle: Comptes clients, profils, consentements; éventuellement KYC.</li>
<li>Agrégats: <code>Customer</code>.</li>
<li>Événements: CustomerRegistered, CustomerUpdated.</li>
</ul>
</li>
<li>
<p>Notification</p>
<ul>
<li>Rôle: Envoi d’emails/SMS (confirmation, billets, annulations, remboursements).</li>
<li>Événements consommés: TicketIssued, OrderPlaced, PaymentRefunded, etc.</li>
</ul>
</li>
<li>
<p>Avis (Notes &amp; Commentaires)</p>
<ul>
<li>Rôle: Permettre aux clients de laisser des notes/commentaires sur des événements ou des performances; modération simple.</li>
<li>Agrégats: <code>Review</code> (note 1–5, texte, cible: event/performance), <code>ReviewFlag</code>.</li>
<li>Commandes: CreateReview, UpdateReview, DeleteReview, FlagReview.</li>
<li>Événements: ReviewCreated, ReviewUpdated, ReviewDeleted, ReviewFlagged.</li>
</ul>
</li>
<li>
<p>Support Client</p>
<ul>
<li>Rôle: Gérer les tickets de support (questions, problèmes) liés aux commandes, paiements, billets.</li>
<li>Agrégats: <code>SupportTicket</code> (statut, sujet, description, liens vers order/payment/ticket), <code>SupportMessage</code>.</li>
<li>Commandes: CreateTicket, UpdateTicket, CloseTicket, AddMessage, AssignTicket.</li>
<li>Événements: SupportTicketCreated, SupportTicketUpdated, SupportTicketClosed, SupportMessageAdded, SupportTicketAssigned.</li>
</ul>
</li>
</ol>
<p>Relations typiques (patterns):</p>
<ul>
<li>Customer–Supplier: Event Management (supplier) → Catalogue (customer)</li>
<li>Conformist/ACL: Reservation consomme Inventory via ACL ou API dédiée pour éviter le couplage au modèle d’Inventory.</li>
<li>Anticorruption Layer: Order &amp; Payment vers PSP (Prestataire Paiement).</li>
</ul>
<hr>
<h3 id="3-carte-des-domaines-context-map">3) Carte des Domaines (Context Map) </h3>
<div class="mermaid">graph LR
	subgraph "Event Management"
		EM[Event Mgmt]
	end
	subgraph "Venue &amp; Seating / Inventory"
		INV[Inventory]
	end
	subgraph "Catalogue (Read)"
		CAT[Catalogue]
	end
	subgraph "Reservation"
		RSV[Reservation]
	end
	subgraph "Order &amp; Payment"
		ORD[Order]
		PAY[Payment]
	end
	subgraph "Ticketing &amp; Access"
		TIC[Ticketing]
	end
	subgraph "Customer/Identity"
		CUS[Customer]
	end
	subgraph "Notification"
		NOTIF[Notification]
	end
		subgraph "Avis (Reviews)"
			REV[Avis]
		end
		subgraph "Support Client"
			SUP[Support]
		end
	subgraph "PSP / Banque"
		PSP[(PSP)]
	end

	EM -- EventPublished/PerformanceScheduled --&gt; CAT
	EM -- EventPublished --&gt; INV
	INV -- CapacityAdjusted/AvailabilityUpdated --&gt; CAT
	CAT -- Browse/Query --&gt; CAT
	CUS -- Authn/Authz --&gt; RSV
	CAT -- SelectEvent/Seats --&gt; RSV
	RSV -- ReserveSeats --&gt; INV
	INV -- SeatsReserved/SeatsReleased --&gt; RSV
	RSV -- PlaceOrder --&gt; ORD
	ORD -- RequestPayment --&gt; PAY
	PAY -- Capture/Refund --&gt; PSP
	PSP -- PaymentCaptured/Failed --&gt; PAY
	PAY -- PaymentCaptured --&gt; ORD
	ORD -- OrderPaid --&gt; TIC
	TIC -- TicketIssued --&gt; NOTIF
	ORD -- RefundProcessed --&gt; NOTIF
	REV -- ReviewCreated/Updated/Deleted/Flagged --&gt; CAT
	CAT -- Read/Aggregate Ratings --&gt; CAT
	CUS -- Authn/Authz --&gt; REV
	EM -- EventPublished --&gt; REV
	EM -- PerformanceScheduled --&gt; REV
	ORD -- OrderPaid/Cancelled --&gt; SUP
	PAY -- PaymentFailed/Refunded --&gt; SUP
	TIC -- TicketIssued --&gt; SUP
	SUP -- SupportTicketCreated/Updated/Closed --&gt; NOTIF
</div><p>Légende relationnelle: EM→CAT (Customer–Supplier), RSV→INV (ACL/Contract), PAY↔PSP (ACL &amp; Adapter), événements asynchrones pour la cohérence éventuelle.</p>
<hr>
<h3 id="4-modèle-conceptuel-initial-entités--value-objects">4) Modèle conceptuel initial (Entités &amp; Value Objects) </h3>
<div class="mermaid">classDiagram
	class Event {
		+EventId id
		+String title
		+String description
		+List~PerformanceId~ performances
		+Status status
	}
	class Performance {
		+PerformanceId id
		+ZonedDateTime startTime
		+VenueId venueId
		+PricingSchemeId pricingId
	}
	class Venue {
		+VenueId id
		+String name
		+Address address
	}
	class SeatingPlan {
		+SeatingPlanId id
		+VenueId venueId
		+List~Seat~ seats
		+List~InventoryBucket~ buckets
	}
	class Seat {
		+SeatId id
		+String section
		+String row
		+String number
	}
	class InventoryBucket {
		+BucketId id
		+String zone
		+int capacity
	}
	class PricingScheme {
		+PricingSchemeId id
		+List~PriceCategory~ categories
	}
	class PriceCategory {
		+String name
		+Money price
	}
	class Money {
		+Decimal amount
		+Currency currency
	}
	class Reservation {
		+ReservationId id
		+CustomerId customerId
		+List~ReservationItem~ items
		+Instant expiresAt
		+Status status
	}
	class ReservationItem {
		+PerformanceId performanceId
		+SeatRef seatRef
		+Quantity qty
		+Money unitPrice
	}
	class SeatRef {
		+SeatId seatId
		+BucketId bucketId
	}
	class Order {
		+OrderId id
		+ReservationId reservationId
		+Money total
		+Status status
	}
	class Payment {
		+PaymentId id
		+OrderId orderId
		+Money amount
		+PaymentStatus status
		+ProviderRef providerRef
	}
	class Ticket {
		+TicketId id
		+OrderId orderId
		+PerformanceId performanceId
		+SeatRef seatRef
		+QrCode qr
		+TicketStatus status
	}
	class Customer {
		+CustomerId id
		+Email email
		+Name name
	}
	class Review {
		+ReviewId id
		+CustomerId authorId
		+TargetType targetType
		+UUID targetId
		+int rating
		+String comment
		+Status status
	}

	Event "1" -- "*" Performance
	Performance "1" -- "1" SeatingPlan
	SeatingPlan "1" -- "*" Seat
	SeatingPlan "1" -- "*" InventoryBucket
	PricingScheme "1" -- "*" PriceCategory
	Reservation "1" -- "*" ReservationItem
	Order "1" -- "1" Reservation
	Order "1" -- "*" Ticket
	Payment "1" -- "1" Order
	Customer "1" -- "*" Reservation
	Customer "1" -- "*" Review
</div><p>Événements de domaine (exemples):</p>
<ul>
<li>EventCreated, EventPublished, PerformanceScheduled</li>
<li>SeatsReserved, SeatsReleased, AvailabilityUpdated</li>
<li>ReservationStarted, ReservationExpired, ReservationCancelled</li>
<li>OrderPlaced, PaymentCaptured, PaymentFailed, PaymentRefunded</li>
<li>TicketIssued, TicketCheckedIn, TicketRevoked</li>
</ul>
<hr>
<h3 id="décisions-validées-résumé">Décisions validées (résumé) </h3>
<ul>
<li>Modèle d’inventaire: Sièges numérotés ET capacité par zone (hybride), activable par événement; par défaut, zones de capacité pour concerts, sièges nominatifs pour conférences.</li>
<li>Réservations: TTL fixe 10 minutes (configurable), annulation utilisateur jusqu’à 24h avant la performance (remboursement selon politique), annulation organisateur → remboursement total.</li>
<li>PSP: Stripe (SCA/3DS2), webhook signé (<code>Stripe-Signature</code>) exigé; intents/capture via Payment Service, fallback par webhook.</li>
<li>NFR/SLA: API Gateway disponibilité ≥ 99.9% mensuelle; <code>POST /orders</code> p95 &lt; 300 ms; <code>GET /catalog/**</code> p95 &lt; 200 ms; latence de projection Catalogue p95 ≤ 3 s.</li>
<li>Périmètre minimal: 8 services comme définis (Event, Inventory, Catalogue, Reservation, Order, Payment, Ticketing, Notification); endpoints obligatoires listés ci‑dessous.</li>
</ul>
<p>Choix d’outillage (appliqués):</p>
<ul>
<li>Gateway: Envoy (vérification JWT, rate limiting, routing).</li>
<li>IdP: Keycloak (OIDC/OAuth2, rôles/scopes, JWKS).</li>
<li>Mode check‑in offline: non supporté par défaut; mode dégradé limité (cache local de 5 minutes max, resynchronisation obligatoire) pour éviter la fraude.</li>
<li>Politique d’annulation/remboursement:
<ul>
<li>Annulation client: jusqu’à 24h avant la performance, remboursement à 100%.</li>
<li>Annulation &lt; 24h: pas de remboursement, sauf cas de force majeure (à l’appréciation de l’organisateur).</li>
<li>Événement annulé par l’organisateur: remboursement à 100%.</li>
<li>Frais: 0€ de frais pour les remboursements standards dans le périmètre du cours.</li>
</ul>
</li>
</ul>
<p>Ces choix sont appliqués dans Inventory, Reservation, Payment et les SLOs.</p>
<hr>
<h2 id="décomposition-en-microservices">Décomposition en Microservices </h2>
<p>Nombre de services (proposé): 10 au total — 6 « core » (Event, Inventory, Catalogue, Reservation, Order, Ticketing) + 4 « transverses » (Payment, Notification, Avis, Support). L’identité (Customer/Auth) peut être externalisée (IdP) ou réduite à un profil léger.</p>
<p>Justification du découpage:</p>
<ul>
<li>Autonomie de données: chaque service possède ses agrégats et ses tables/index.</li>
<li>Fréquence de changement: la tarification/programmation (Event) évolue différemment de la billetterie (Ticketing) et du paiement (Payment).</li>
<li>Scalabilité spécifique: lecture catalogue, réservations « bursty », check-in temps réel.</li>
<li>Faible couplage via événements: cohérence éventuelle acceptée pour catalogue et ticketing.</li>
</ul>
<h3 id="services-responsabilités-dépendances-et-stockage">Services, responsabilités, dépendances et stockage </h3>
<ol>
<li>Event Service (Event Management)</li>
</ol>
<ul>
<li>Responsabilités: création/édition d’événements, séances, pricing; publication/archivage.</li>
<li>API/Events: Commands (Create/Update/Publish), events (EventCreated, EventPublished, PerformanceScheduled).</li>
<li>Dépendances: publie des événements vers le bus; pas d’appel synchrone requis côté core.</li>
<li>Base de données: PostgreSQL (relationnel) — modèles fortement structurés (events/séances/prix), contraintes d’intégrité, transactions simples.</li>
</ul>
<ol start="2">
<li>Inventory Service (Venue &amp; Seating)</li>
</ol>
<ul>
<li>Responsabilités: plans de salle, sièges, capacités, réservations de stock (sièges ou buckets).</li>
<li>API/Events: ReserveSeats, ReleaseSeats; events (SeatsReserved, SeatsReleased, CapacityAdjusted).</li>
<li>Dépendances: appelé de façon synchrone par Reservation pour réserver/libérer; émet des événements pour projections.</li>
<li>Base de données: PostgreSQL (structure de plan/sièges) + Redis (compteurs/disponibilité/hyper-rapide) — justification: concurrence fine et TTL rapides.</li>
</ul>
<ol start="3">
<li>Catalogue Service (Read/Search)</li>
</ol>
<ul>
<li>Responsabilités: vue client pour recherche/filtrage, disponibilité agrégée, SEO-friendly.</li>
<li>API/Events: queries REST/GraphQL; consomme EventPublished/CapacityAdjusted pour alimenter ses read models.</li>
<li>Dépendances: uniquement asynchrones (consumer d’événements) — pas d’appel synchrone.</li>
<li>Base de données: OpenSearch/Elasticsearch (indexation &amp; recherche full-text/facettes) + cache Redis optionnel.</li>
</ul>
<ol start="4">
<li>Reservation Service (Panier &amp; Holds)</li>
</ol>
<ul>
<li>Responsabilités: démarrer une réservation, ajouter items, gérer expiration/annulation.</li>
<li>API/Events: StartReservation, AddItem, Confirm/Cancel; events (ReservationStarted, ReservationExpired, ReservationCancelled).</li>
<li>Dépendances: appel synchrone à Inventory (Reserve/Release) via ACL; émet vers Order à la confirmation.</li>
<li>Base de données: PostgreSQL (état des réservations) + Redis (holds/locks avec TTL) — justification: expirations fiables et rapides.</li>
</ul>
<ol start="5">
<li>Order Service (Commande)</li>
</ol>
<ul>
<li>Responsabilités: créer commandes à partir des réservations confirmées, calcul total, statut (en_attente, payé, remboursé).</li>
<li>API/Events: PlaceOrder, MarkPaid/Failed; events (OrderPlaced, OrderPaid, OrderCancelled).</li>
<li>Dépendances: appel synchrone au Payment Service pour initier/capturer; outbox pour fiabiliser les événements.</li>
<li>Base de données: PostgreSQL — transactions, intégrité, outbox pattern pour publication d’événements.</li>
</ul>
<ol start="6">
<li>Payment Service (Paiement)</li>
</ol>
<ul>
<li>Responsabilités: intégration PSP (ex. Stripe), intents, captures, remboursements, webhooks.</li>
<li>API/Events: CapturePayment, RefundPayment; events (PaymentCaptured, PaymentFailed, PaymentRefunded).</li>
<li>Dépendances: externe vers PSP; callbacks webhooks → idempotence et vérification signature.</li>
<li>Base de données: PostgreSQL — suivi des intents/transactions + table d’idempotence; outbox pour fiabilité.</li>
</ul>
<ol start="7">
<li>Ticketing Service (Émission &amp; Accès)</li>
</ol>
<ul>
<li>Responsabilités: générer billets (QR/PDF), statut (valide/annulé/utilisé), check-in temps réel.</li>
<li>API/Events: IssueTickets, Revoke, CheckIn; events (TicketIssued, TicketCheckedIn).</li>
<li>Dépendances: consomme OrderPaid; pas d’appel synchrone critique aux autres; exposition d’un endpoint check-in faible latence.</li>
<li>Base de données: PostgreSQL (billets, logs de scan) + stockage objet (PDF) + Redis optionnel pour tokens de scan rapides.</li>
</ul>
<ol start="8">
<li>Notification Service (Emails/SMS)</li>
</ol>
<ul>
<li>Responsabilités: envoi de confirmations, billets, annulations, remboursements, relances.</li>
<li>API/Events: consomme TicketIssued, OrderPlaced/Paid, PaymentRefunded.</li>
<li>Dépendances: broker uniquement; pas d’appels synchrones nécessaires.</li>
<li>Base de données: (optionnel) PostgreSQL pour templates/outbox; sinon stateless + broker.</li>
</ul>
<ol start="9">
<li>Avis Service (Notes &amp; Commentaires)</li>
</ol>
<ul>
<li>Responsabilités: création/édition/suppression de commentaires, attribution de notes (1–5), flags/modération.</li>
<li>API/Events: Create/Update/Delete/Flag; events (ReviewCreated, ReviewUpdated, ReviewDeleted, ReviewFlagged).</li>
<li>Dépendances: consomme EventPublished/PerformanceScheduled (pour référencer les cibles); publie événements vers Catalogue pour agrégations de notes.</li>
<li>Base de données: PostgreSQL (tables <code>reviews</code>, <code>review_flags</code>) + outbox pour publication.</li>
</ul>
<ol start="10">
<li>Support Service (Support Client)</li>
</ol>
<ul>
<li>Responsabilités: tickets de support (création, messages, assignation, clôture), lien avec commandes/paiements/billets.</li>
<li>API/Events: CreateTicket/UpdateTicket/CloseTicket/AddMessage/Assign; events (SupportTicketCreated, SupportTicketUpdated, SupportTicketClosed, SupportMessageAdded, SupportTicketAssigned).</li>
<li>Dépendances: consomme <code>order.paid</code>, <code>payment.failed/refunded</code>, <code>ticket.issued</code> pour contexte; peut notifier via Notification.</li>
<li>Base de données: PostgreSQL (tables <code>support_tickets</code>, <code>support_messages</code>) + outbox.</li>
</ul>
<p>Remarque identité: Customer/Auth peut s’appuyer sur un IdP (ex. Keycloak/Auth0) — profils clients légers stockés côté service consommateur si besoin (CQRS/duplication contrôlée).</p>
<h3 id="dépendances-et-communication">Dépendances et communication </h3>
<ul>
<li>Synchronous (critique): Reservation → Inventory (réservation immédiate de stock); Order → Payment (capture). Ces appels sont protégés par timeouts/retries, idempotence.</li>
<li>Asynchronous (événements): Event → Catalogue/Inventory; Inventory → Catalogue/Reservation; Payment → Order; Order → Ticketing; Ticketing → Notification. Cohérence éventuelle acceptée pour lecture/émission.</li>
<li>Contrats &amp; ACL: Reservation parle à Inventory via ACL (anti-corruption) pour éviter le couplage au modèle interne d’Inventory; Payment encapsule le PSP via un adapter.</li>
<li>Fiabilité: Outbox + broker (RabbitMQ) pour éviter la perte d’événements; consumers idempotents.</li>
<li>Transactions: éviter les 2PC; préférer Sagas (choreography) pour flux Réservation→Commande→Paiement→Billets.</li>
</ul>
<h3 id="vue-densemble-services--bases-de-données">Vue d’ensemble (services + bases de données) </h3>
<div class="mermaid">graph LR
	subgraph Event
		S1[Event Service]
		DB1[(PostgreSQL)]
	end
	subgraph Inventory
		S2[Inventory Service]
		DB2a[(PostgreSQL)]
		DB2b[(Redis)]
	end
	subgraph Catalogue
		S3[Catalogue Service]
		DB3[(OpenSearch)]
	end
	subgraph Reservation
		S4[Reservation Service]
		DB4a[(PostgreSQL)]
		DB4b[(Redis TTL)]
	end
	subgraph Order
		S5[Order Service]
		DB5[(PostgreSQL)]
	end
	subgraph Payment
		S6[Payment Service]
		DB6[(PostgreSQL)]
		PSP[(PSP externe)]
	end
	subgraph Ticketing
		S7[Ticketing Service]
		DB7[(PostgreSQL)]
	end
	subgraph Notification
		S8[Notification Service]
	end
	subgraph Avis
		S9[Avis Service]
		DB9[(PostgreSQL)]
	end
	subgraph Support
		S10[Support Service]
		DB10[(PostgreSQL)]
	end
	BUS{{Message Broker}}

	S1 -- events --&gt; BUS
	S2 -- events --&gt; BUS
	S3 -- consume --&gt; BUS
	S4 -- consume --&gt; BUS
	S5 -- events --&gt; BUS
	S6 -- events --&gt; BUS
	S7 -- consume --&gt; BUS
	S8 -- consume --&gt; BUS
	S9 -- events --&gt; BUS
	S10 -- events --&gt; BUS

	S4 -- Reserve/Release (sync) --&gt; S2
	S5 -- Capture (sync) --&gt; S6
	S6 -- API --&gt; PSP

	S1 --- DB1
	S2 --- DB2a
	S2 --- DB2b
	S3 --- DB3
	S4 --- DB4a
	S4 --- DB4b
	S5 --- DB5
	S6 --- DB6
	S7 --- DB7
	S9 --- DB9
	S10 --- DB10
</div><h3 id="règles--base-par-service--et-polyglotte">Règles « base par service » et polyglotte </h3>
<ul>
<li>Un service = son propre schéma de données; pas de lecture croisée directe (pas de jointures inter-services).</li>
<li>Polyglot persistence: chaque service choisit le stockage optimisé pour son besoin (transactions vs recherche vs TTL).</li>
<li>Données en lecture: dupliquées via événements vers les read models (Catalogue) pour découplage et performance.</li>
</ul>
<hr>
<h2 id="spécification-des-apis">Spécification des APIs </h2>
<p>Cette section décrit: endpoints REST (verbe, URL, paramètres, corps), formats d’échange (DTO), événements publiés/consommés (nom + schéma), statuts HTTP et codes d’erreur.</p>
<h3 id="conventions-générales-dto">Conventions générales (DTO) </h3>
<ul>
<li>Encodage: JSON UTF-8; <code>Content-Type: application/json</code>.</li>
<li>Identifiants: UUID v4 en chaîne (<code>"550e8400-e29b-41d4-a716-446655440000"</code>).</li>
<li>Dates/Heures: ISO 8601 en UTC (<code>2025-03-21T19:30:00Z</code>).</li>
<li>Montants: objet <code>Money { currency: "EUR", amount: "49.90" }</code> (decimal string).</li>
<li>Pagination: <code>page</code>, <code>size</code>; réponse inclut <code>page</code>, <code>size</code>, <code>total</code>, <code>items</code>.</li>
<li>Idempotence: entêtes <code>Idempotency-Key</code> pour <code>POST</code> sensibles (paiements, commandes, réservations).</li>
<li>Concurrence optimiste: <code>ETag</code> + <code>If-Match</code> sur ressources éditables.</li>
<li>Corrélation: entête <code>X-Correlation-Id</code> et propagée dans événements.</li>
</ul>
<h3 id="format-derreur-standard">Format d’erreur (standard) </h3>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
	<span class="token property">"error"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"validation_error"</span><span class="token punctuation">,</span>
		<span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Champ 'title' requis"</span><span class="token punctuation">,</span>
		<span class="token property">"details"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
			<span class="token punctuation">{</span> <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token property">"issue"</span><span class="token operator">:</span> <span class="token string">"required"</span> <span class="token punctuation">}</span>
		<span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token property">"correlationId"</span><span class="token operator">:</span> <span class="token string">"f9c1a3f8-4f4c-4d69-a2a8-4a6e7d0d1234"</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="statuts-http-typiques">Statuts HTTP typiques </h3>
<ul>
<li>200 OK, 201 Created (+ <code>Location</code>), 202 Accepted (traitement asynchrone), 204 No Content</li>
<li>400 Bad Request (validation), 401 Unauthorized, 403 Forbidden, 404 Not Found</li>
<li>409 Conflict (stock indisponible/concurrence), 410 Gone (réservation expirée), 422 Unprocessable Entity (règle métier)</li>
<li>429 Too Many Requests, 500 Internal Server Error, 503 Service Unavailable</li>
</ul>
<hr>
<h3 id="endpoints-obligatoires-exigences-minimales">Endpoints obligatoires (exigences minimales) </h3>
<ul>
<li>
<p>Catalogue:</p>
<ul>
<li><code>GET /catalog/events</code></li>
<li><code>GET /catalog/events/{eventId}</code></li>
<li><code>GET /catalog/performances/{performanceId}/availability</code></li>
</ul>
</li>
<li>
<p>Reservation:</p>
<ul>
<li><code>POST /reservations</code></li>
<li><code>POST /reservations/{reservationId}/items</code></li>
<li><code>POST /reservations/{reservationId}/confirm</code></li>
<li><code>DELETE /reservations/{reservationId}</code></li>
</ul>
</li>
<li>
<p>Inventory:</p>
<ul>
<li><code>POST /inventory/holds</code></li>
<li><code>POST /inventory/holds/{holdId}/release</code></li>
</ul>
</li>
<li>
<p>Order:</p>
<ul>
<li><code>POST /orders</code></li>
<li><code>GET /orders/{orderId}</code></li>
</ul>
</li>
<li>
<p>Payment:</p>
<ul>
<li><code>POST /payments/intents</code></li>
<li><code>POST /payments/{paymentId}/capture</code></li>
<li><code>POST /payments/{paymentId}/refunds</code></li>
<li><code>POST /webhooks/psp</code></li>
</ul>
</li>
<li>
<p>Ticketing:</p>
<ul>
<li><code>POST /tickets/issue</code></li>
<li><code>GET /tickets/{ticketId}</code></li>
<li><code>POST /tickets/{ticketId}/check-in</code></li>
</ul>
</li>
<li>
<p>Notification (optionnel):</p>
<ul>
<li><code>POST /notifications/test</code></li>
</ul>
</li>
<li>
<p>Avis:</p>
<ul>
<li><code>POST /reviews</code></li>
<li><code>GET /reviews?eventId={eventId}</code></li>
<li><code>GET /reviews?performanceId={performanceId}</code></li>
<li><code>PUT /reviews/{reviewId}</code></li>
<li><code>DELETE /reviews/{reviewId}</code></li>
<li><code>POST /reviews/{reviewId}/flag</code></li>
</ul>
</li>
<li>
<p>Support:</p>
<ul>
<li><code>POST /support/tickets</code></li>
<li><code>GET /support/tickets/{ticketId}</code></li>
<li><code>PUT /support/tickets/{ticketId}</code></li>
<li><code>POST /support/tickets/{ticketId}/messages</code></li>
<li><code>POST /support/tickets/{ticketId}/close</code></li>
</ul>
</li>
</ul>
<h3 id="event-service-event-management">Event Service (Event Management) </h3>
<ul>
<li>
<p>POST <code>/events</code></p>
<ul>
<li>Body:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Concert X"</span><span class="token punctuation">,</span> <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"performances"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"pricing"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"categories"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"Standard"</span><span class="token punctuation">,</span><span class="token property">"price"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"39.00"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre><ul>
<li>201 → <code>{ "eventId": "..." }</code></li>
</ul>
</li>
<li>
<p>PUT <code>/events/{eventId}</code> (If-Match ETag)</p>
</li>
<li>
<p>POST <code>/events/{eventId}/publish</code></p>
</li>
<li>
<p>POST <code>/events/{eventId}/performances</code></p>
<ul>
<li>Body:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"startTime"</span><span class="token operator">:</span><span class="token string">"2025-06-01T19:30:00Z"</span><span class="token punctuation">,</span> <span class="token property">"venueId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"pricingId"</span><span class="token operator">:</span><span class="token string">"..."</span> <span class="token punctuation">}</span>
</code></pre></li>
</ul>
<p>Événements publiés (CloudEvents-like envelope):</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
	<span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span>
	<span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"event.created"</span><span class="token punctuation">,</span>
	<span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"event-service"</span><span class="token punctuation">,</span>
	<span class="token property">"specversion"</span><span class="token operator">:</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span>
	<span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"2025-05-01T10:00:00Z"</span><span class="token punctuation">,</span>
	<span class="token property">"correlationId"</span><span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span>
	<span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"eventId"</span><span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Concert X"</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Types: <code>event.created</code>, <code>event.published</code>, <code>performance.scheduled</code>.</p>
<hr>
<h3 id="inventory-service-venue--seating">Inventory Service (Venue &amp; Seating) </h3>
<ul>
<li>
<p>POST <code>/venues</code> → crée un lieu</p>
</li>
<li>
<p>POST <code>/venues/{venueId}/seating-plans</code> → définit un plan</p>
</li>
<li>
<p>POST <code>/inventory/holds</code></p>
<ul>
<li>Réserve des sièges/quotas avec TTL.</li>
<li>Body:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"seats"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"seatId"</span><span class="token operator">:</span><span class="token string">"A-12"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">"seatId"</span><span class="token operator">:</span><span class="token string">"A-13"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"ttlSeconds"</span><span class="token operator">:</span><span class="token number">300</span> <span class="token punctuation">}</span>
</code></pre><ul>
<li>201 → <code>{ "holdId":"...", "expiresAt":"2025-06-01T18:35:00Z" }</code></li>
</ul>
</li>
<li>
<p>POST <code>/inventory/holds/{holdId}/release</code> → libère</p>
</li>
</ul>
<p>Événements: <code>seats.reserved</code>, <code>seats.released</code>, <code>capacity.adjusted</code> avec payload:</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"holdId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"seats"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"A-12"</span><span class="token punctuation">,</span><span class="token string">"A-13"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"expiresAt"</span><span class="token operator">:</span><span class="token string">"..."</span> <span class="token punctuation">}</span>
</code></pre><hr>
<h3 id="catalogue-service-readsearch">Catalogue Service (Read/Search) </h3>
<ul>
<li>
<p>GET <code>/catalog/events?query=&amp;from=&amp;to=&amp;city=&amp;page=&amp;size=</code></p>
<ul>
<li>200 →</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"page"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"size"</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token property">"total"</span><span class="token operator">:</span><span class="token number">124</span><span class="token punctuation">,</span> <span class="token property">"items"</span><span class="token operator">:</span><span class="token punctuation">[</span> <span class="token punctuation">{</span><span class="token property">"eventId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span><span class="token property">"title"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span><span class="token property">"nextPerformance"</span><span class="token operator">:</span><span class="token string">"2025-06-01T19:30:00Z"</span><span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre></li>
<li>
<p>GET <code>/catalog/events/{eventId}</code></p>
</li>
<li>
<p>GET <code>/catalog/performances/{performanceId}/availability</code></p>
<ul>
<li>200 → <code>{ "available": true, "remaining": 42 }</code> (ou par zone/siège)</li>
</ul>
</li>
</ul>
<p>Consomme événements: <code>event.published</code>, <code>performance.scheduled</code>, <code>capacity.adjusted</code>.</p>
<hr>
<h3 id="reservation-service-panier--holds">Reservation Service (Panier &amp; Holds) </h3>
<ul>
<li>
<p>POST <code>/reservations</code> (Idempotency-Key)</p>
<ul>
<li>Body:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"customerId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"expiresInSeconds"</span><span class="token operator">:</span><span class="token number">300</span> <span class="token punctuation">}</span>
</code></pre><ul>
<li>201 → <code>{ "reservationId":"...", "status":"pending", "expiresAt":"..." }</code></li>
</ul>
</li>
<li>
<p>POST <code>/reservations/{reservationId}/items</code></p>
<ul>
<li>Body:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"items"</span><span class="token operator">:</span><span class="token punctuation">[</span> <span class="token punctuation">{</span><span class="token property">"seatId"</span><span class="token operator">:</span><span class="token string">"A-12"</span><span class="token punctuation">,</span><span class="token property">"unitPrice"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"39.00"</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre></li>
<li>
<p>POST <code>/reservations/{reservationId}/confirm</code></p>
<ul>
<li>200 → <code>{ "reservationId":"...", "status":"confirmed" }</code> (déclenche <code>PlaceOrder</code>)</li>
</ul>
</li>
<li>
<p>DELETE <code>/reservations/{reservationId}</code> → annule et libère holds</p>
</li>
</ul>
<p>Événements: <code>reservation.started</code>, <code>reservation.item.added</code>, <code>reservation.expired</code>, <code>reservation.cancelled</code>.</p>
<hr>
<h3 id="order-service-commande">Order Service (Commande) </h3>
<ul>
<li>
<p>POST <code>/orders</code> (souvent interne après confirmation)</p>
<ul>
<li>Body:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"reservationId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"78.00"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre><ul>
<li>201 → <code>{ "orderId":"...", "status":"pending" }</code></li>
</ul>
</li>
<li>
<p>GET <code>/orders/{orderId}</code> → détail</p>
</li>
</ul>
<p>Événements: <code>order.placed</code>, <code>order.paid</code>, <code>order.cancelled</code>.</p>
<hr>
<h3 id="payment-service-paiement">Payment Service (Paiement) </h3>
<ul>
<li>
<p>POST <code>/payments/intents</code> (Idempotency-Key)</p>
<ul>
<li>Body:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"78.00"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"method"</span><span class="token operator">:</span><span class="token string">"card"</span> <span class="token punctuation">}</span>
</code></pre><ul>
<li>201 → <code>{ "paymentId":"...", "clientSecret":"...", "status":"requires_action" }</code></li>
</ul>
</li>
<li>
<p>POST <code>/payments/{paymentId}/capture</code></p>
</li>
<li>
<p>POST <code>/payments/{paymentId}/refunds</code></p>
</li>
<li>
<p>POST <code>/webhooks/psp</code> (callback PSP) — vérification de signature</p>
</li>
</ul>
<p>Événements: <code>payment.captured</code>, <code>payment.failed</code>, <code>payment.refunded</code>.</p>
<hr>
<h3 id="ticketing-service-émission--accès">Ticketing Service (Émission &amp; Accès) </h3>
<ul>
<li>
<p>POST <code>/tickets/issue</code></p>
<ul>
<li>Body:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"..."</span> <span class="token punctuation">}</span>
</code></pre><ul>
<li>201 → <code>{ "tickets":[{"ticketId":"...","qr":"data:..."}] }</code></li>
</ul>
</li>
<li>
<p>GET <code>/tickets/{ticketId}</code></p>
</li>
<li>
<p>POST <code>/tickets/{ticketId}/check-in</code></p>
<ul>
<li>200 → <code>{ "status":"checked_in", "at":"2025-06-01T19:05:00Z" }</code></li>
</ul>
</li>
</ul>
<p>Événements: <code>ticket.issued</code>, <code>ticket.checked_in</code>, <code>ticket.revoked</code>.</p>
<hr>
<h3 id="notification-service">Notification Service </h3>
<ul>
<li>Principalement event-driven; optionnel:
<ul>
<li>POST <code>/notifications/test</code> (diagnostic)</li>
<li>GET <code>/templates</code></li>
</ul>
</li>
</ul>
<p>Consomme: <code>ticket.issued</code>, <code>order.paid</code>, <code>payment.refunded</code>.</p>
<hr>
<h3 id="avis-service-reviews">Avis Service (Reviews) </h3>
<ul>
<li>
<p>POST <code>/reviews</code></p>
<ul>
<li>Body:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"targetType"</span><span class="token operator">:</span> <span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token property">"targetId"</span><span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"rating"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token property">"comment"</span><span class="token operator">:</span> <span class="token string">"Très bon concert"</span> <span class="token punctuation">}</span>
</code></pre><ul>
<li>201 → <code>{ "reviewId": "..." }</code></li>
</ul>
</li>
<li>
<p>GET <code>/reviews</code></p>
<ul>
<li>Query: <code>eventId</code> ou <code>performanceId</code></li>
<li>200 → <code>[{ "reviewId":"...", "authorId":"...", "rating":4, "comment":"..." }]</code></li>
</ul>
</li>
<li>
<p>PUT <code>/reviews/{reviewId}</code></p>
<ul>
<li>Body: <code>{ "rating": 4, "comment": "mise à jour" }</code></li>
<li>200 → review mise à jour</li>
</ul>
</li>
<li>
<p>DELETE <code>/reviews/{reviewId}</code></p>
<ul>
<li>204</li>
</ul>
</li>
<li>
<p>POST <code>/reviews/{reviewId}/flag</code></p>
<ul>
<li>Body: <code>{ "reason": "spam" }</code></li>
<li>202 → flag enregistré</li>
</ul>
</li>
</ul>
<p>Événements publiés:</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"review.created"</span><span class="token punctuation">,</span> <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"avis-service"</span><span class="token punctuation">,</span> <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"reviewId"</span><span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"targetType"</span><span class="token operator">:</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token property">"targetId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"rating"</span><span class="token operator">:</span><span class="token number">5</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"review.updated"</span><span class="token punctuation">,</span> <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"avis-service"</span><span class="token punctuation">,</span> <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"reviewId"</span><span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"rating"</span><span class="token operator">:</span><span class="token number">4</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"review.deleted"</span><span class="token punctuation">,</span> <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"avis-service"</span><span class="token punctuation">,</span> <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"reviewId"</span><span class="token operator">:</span> <span class="token string">"uuid"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"review.flagged"</span><span class="token punctuation">,</span> <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"avis-service"</span><span class="token punctuation">,</span> <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"reviewId"</span><span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"reason"</span><span class="token operator">:</span><span class="token string">"spam"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre><p>Consommateurs:</p>
<ul>
<li>Catalogue: agrège moyenne et nombre de reviews par <code>eventId</code>/<code>performanceId</code> pour la lecture.</li>
<li>Notification (optionnel): peut notifier l’organisateur en cas de <code>review.flagged</code>.</li>
</ul>
<hr>
<h3 id="schéma-denveloppe-dévénement-cloudevents-like">Schéma d’enveloppe d’événement (CloudEvents-like) </h3>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
	<span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string (ex: payment.captured)"</span><span class="token punctuation">,</span>
	<span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span>
	<span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"service-name"</span><span class="token punctuation">,</span>
	<span class="token property">"specversion"</span><span class="token operator">:</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span>
	<span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"ISO-8601"</span><span class="token punctuation">,</span>
	<span class="token property">"correlationId"</span><span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span>
	<span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Exemples de payloads <code>data</code>:</p>
<ul>
<li><code>payment.captured</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"paymentId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"78.00"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre><ul>
<li><code>seats.reserved</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"holdId"</span><span class="token operator">:</span><span class="token string">"..."</span><span class="token punctuation">,</span> <span class="token property">"seats"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"A-12"</span><span class="token punctuation">,</span><span class="token string">"A-13"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"expiresAt"</span><span class="token operator">:</span><span class="token string">"..."</span> <span class="token punctuation">}</span>
</code></pre><hr>
<h2 id="stratégie-de-cohérence">Stratégie de Cohérence </h2>
<p>Objectif: déterminer où la cohérence forte est requise et où une cohérence éventuelle est acceptable, puis définir une Saga de réservation (étapes, messages, compensations).</p>
<h3 id="cohérence-forte-requise">Cohérence forte (requise) </h3>
<ul>
<li>Inventory (réservation de sièges/capacité): l’allocation d’un siège ou décrément d’un quota doit être atomique et sérialisée au niveau du service Inventory.
<ul>
<li>Technique: transaction DB avec verrouillage ligne/unique constraint (clé unique <code>(performanceId, seatId, holdActive=true)</code>), ou compteur atomique sur bucket; éventuellement Redis pour vitesse mais PostgreSQL reste source de vérité.</li>
<li>API synchrone: Reservation appelle Inventory et attend succès/échec immédiat pour décider.</li>
</ul>
</li>
<li>Ticketing (check-in): la transition d’état d’un billet (valid → used) doit être atomique pour éviter la double entrée.
<ul>
<li>Technique: transaction locale + contrainte d’unicité sur <code>(ticketId, used=false)</code>; cache permissif possible mais validation finale en DB.</li>
</ul>
</li>
<li>Payment (capture/remboursement): cohérence forte à l’intérieur du service (statut du payment), idempotence stricte côté webhooks/capture.</li>
</ul>
<h3 id="cohérence-éventuelle-acceptable">Cohérence éventuelle (acceptable) </h3>
<ul>
<li>Catalogue (read/search): projections alimentées par événements; latence acceptable (SLO p95 ≤ 3s) entre publication et visibilité.</li>
<li>Notifications: envoi best-effort avec retries; pas de transaction métier dépendante de l’envoi.</li>
<li>Synchronisation des profils clients et vues d’agrégats: copies CQRS locales, mises à jour asynchrones.</li>
<li>Libération d’un hold par expiration: déclenchée par TTL/cron; libération visible avec légère latence.</li>
</ul>
<h3 id="principes">Principes </h3>
<ul>
<li>Pas de 2PC: préférer Sagas et Outbox pattern pour la publication d’événements.</li>
<li>Idempotence: clés d’idempotence pour <code>POST</code> critiques (réservations, paiements), dédupe côté consommateurs.</li>
<li>At-least-once: consommateurs idempotents; événements versionnés.</li>
<li>Timeouts/Retry: appels sync avec <code>timeout</code> + <code>retry</code> exponentiel et circuit breaker.</li>
</ul>
<hr>
<h3 id="saga-de-réservation-choreography">Saga de Réservation (Choreography) </h3>
<p>Narratif (succès):</p>
<ol>
<li>Client démarre une réservation (ReservationStarted).</li>
<li>Reservation envoie <code>ReserveSeats</code> (sync) → Inventory; Inventory répond OK et publie <code>seats.reserved</code>.</li>
<li>Client confirme la réservation → Reservation publie <code>order.place</code> (ou appelle Order API).</li>
<li>Order crée la commande et demande un paiement → Payment crée l’intent/capture; à succès publie <code>payment.captured</code>.</li>
<li>Order reçoit <code>payment.captured</code> → passe <code>order.paid</code> et publie l’événement.</li>
<li>Ticketing consomme <code>order.paid</code> → émet les billets (<code>ticket.issued</code>). Saga terminée.</li>
</ol>
<p>Compensations (échecs):</p>
<ul>
<li>Échec <code>ReserveSeats</code>: Reservation publie <code>reservation.cancelled</code> (raison: out_of_stock).</li>
<li>Expiration réservation: TTL déclenche <code>reservation.expired</code> → Reservation appelle Inventory <code>ReleaseSeats</code>.</li>
<li>Échec paiement (timeout/failed): Payment publie <code>payment.failed</code> → Order passe <code>order.cancelled</code> → Reservation appelle Inventory <code>ReleaseSeats</code>.</li>
<li>Échec d’émission billets: Ticketing publie <code>ticket.issue.failed</code>; Order peut tenter <code>refund</code> ou marquer <code>order.cancelled</code> et notifier support; si des billets ont été partiellement émis, <code>ticket.revoked</code> + <code>payment.refunded</code>.</li>
</ul>
<p>Orchestration alternative:</p>
<ul>
<li>Orchestrateur = Order Service (ou Reservation). Avantage: visibilité centralisée, inconvénient: couplage accru. Pour ce projet, preferer choreography afin de limiter le couplage.</li>
</ul>
<h3 id="diagramme-de-séquence-succès--échec-paiement">Diagramme de séquence (succès + échec paiement) </h3>
<div class="mermaid">sequenceDiagram
	autonumber
	participant C as Client
	participant RSV as Reservation
	participant INV as Inventory
	participant ORD as Order
	participant PAY as Payment
	participant TIC as Ticketing
	participant BUS as Broker

	C-&gt;&gt;RSV: POST /reservations
	RSV-&gt;&gt;INV: ReserveSeats (sync)
	INV--&gt;&gt;RSV: OK (holdId)
	INV--&gt;&gt;BUS: seats.reserved
	C-&gt;&gt;RSV: POST /reservations/{id}/confirm
	RSV--&gt;&gt;BUS: order.place (cmd/event)
	BUS--&gt;&gt;ORD: order.place
	ORD-&gt;&gt;PAY: POST /payments/intents (capture)
	PAY--&gt;&gt;BUS: payment.captured
	BUS--&gt;&gt;ORD: payment.captured
	ORD--&gt;&gt;BUS: order.paid
	BUS--&gt;&gt;TIC: order.paid
	TIC--&gt;&gt;BUS: ticket.issued

	alt Paiement échoue
		PAY--&gt;&gt;BUS: payment.failed
		BUS--&gt;&gt;ORD: payment.failed
		ORD--&gt;&gt;BUS: order.cancelled
		RSV-&gt;&gt;INV: ReleaseSeats (sync)
		INV--&gt;&gt;BUS: seats.released
	end
</div><h3 id="contrôles-dintégrité-et-patterns">Contrôles d’intégrité et patterns </h3>
<ul>
<li>Unicité sièges: contrainte unique <code>(performanceId, seatId, holdActive)</code> + TTL/expiration.</li>
<li>Outbox: tables outbox par service (Order, Payment, Ticketing) avec publisher fiable.</li>
<li>Idempotency store: table dédiée (Payment/Order) indexée par <code>Idempotency-Key</code>.</li>
<li>Dead-letter queues: pour événements non consommables; alerting pour intervention.</li>
<li>Observabilité: logs corrélés (<code>X-Correlation-Id</code>), métriques latence/erreurs, traces distribuées.</li>
</ul>
<hr>
<h2 id="conception-de-la-sécurité">Conception de la Sécurité </h2>
<p>Note: Voir aussi « Conception de la Sécurité — Détails Auth &amp; Rôles » pour exemples et configurations.</p>
<p>But: définir l’authentification, les rôles et comment on vérifie/autorise côté services.</p>
<h3 id="méthode-dauthentification">Méthode d’authentification </h3>
<ul>
<li>Protocole: OpenID Connect (OIDC) et OAuth2 via un IdP (Keycloak/Auth0).</li>
<li>Flots:
<ul>
<li>Frontend: Authorization Code + PKCE (SPA ou BFF) → tokens courts + refresh.</li>
<li>Service-to-service: Client Credentials avec audience ciblée.</li>
<li>App Check-in: Authorization Code + PKCE, tokens très courts; mTLS possible en interne.</li>
</ul>
</li>
<li>Jetons: JWT signés avec <code>iss</code>, <code>aud</code>, <code>exp</code>, <code>sub</code>, <code>scope</code>, <code>roles</code>.</li>
<li>Stockage tokens: en mémoire (ou BFF avec cookie httpOnly même‑site).</li>
</ul>
<p>Exemple d’extraits de claims:</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
	<span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://idp.example.com/"</span><span class="token punctuation">,</span>
	<span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"reservation-service"</span><span class="token punctuation">,</span>
	<span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"c6f6c1a5-..."</span><span class="token punctuation">,</span> 
	<span class="token property">"scope"</span><span class="token operator">:</span> <span class="token string">"catalog:read reservation:write order:write"</span><span class="token punctuation">,</span>
	<span class="token property">"realm_access"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"roles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"CUSTOMER"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">"resource_access"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"event-service"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"roles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ORGANIZER"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">"ticketing-service"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"roles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"CHECKIN"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="rôles-et-permissions-rbac--règles-métier">Rôles et permissions (RBAC + règles métier) </h3>
<ul>
<li>Rôles principaux:
<ul>
<li><code>CUSTOMER</code>: parcourir le catalogue, créer/valider une réservation, payer, consulter ses billets.</li>
<li><code>ORGANIZER</code>: créer/éditer/publier événements et séances, configurer plans/prix, consulter ventes de ses événements.</li>
<li><code>CHECKIN</code>: contrôler l’accès (scan), voir les billets d’un événement assigné.</li>
<li><code>ADMIN</code>: gestion globale (venues, utilisateurs, audit), opérations sensibles.</li>
</ul>
</li>
</ul>
<p>Matrice (extraits):</p>
<ul>
<li>Event Service: <code>ORGANIZER</code> (owner) → CRUD sur ses <code>Event</code>/<code>Performance</code>; <code>ADMIN</code> → global. Vérifier ownership (<code>event.ownerId == sub</code>) côté service.</li>
<li>Inventory: <code>ORGANIZER</code>/<code>ADMIN</code> → plans de salle pour leurs événements; <code>Reservation</code> (service account) → réserver/libérer (scope <code>inventory:hold</code>).</li>
<li>Catalogue: <code>ANONYMOUS</code>/<code>CUSTOMER</code> → lecture publique.</li>
<li>Reservation: <code>CUSTOMER</code> → CRUD de sa réservation (<code>reservation.customerId == sub</code>).</li>
<li>Order/Payment: <code>CUSTOMER</code> → commandes/paiements propres; <code>ADMIN</code> → remboursement.</li>
<li>Ticketing: <code>CHECKIN</code> → check-in; <code>CUSTOMER</code> → lecture de ses billets.</li>
<li>Notification: interne (event-driven); endpoints, si exposés, limités à <code>ADMIN</code>.</li>
<li>Avis: <code>CUSTOMER</code> → créer/modifier/supprimer ses propres reviews; <code>ADMIN</code>/<code>ORGANIZER</code> → modération (flag/suppression) sur événements dont ils sont propriétaires.</li>
<li>Support: <code>CUSTOMER</code> → créer/lire ses tickets; <code>ADMIN</code>/support → assigner et clôturer; lecture des liens (order/payment/ticket) via scopes dédiés.</li>
</ul>
<p>Règles d’autorisation supplémentaires (ABAC):</p>
<ul>
<li>Ownership: vérifier que <code>sub</code> du token correspond au propriétaire de la ressource (event, reservation, order) au moment de l’action.</li>
<li>Scopes: <code>catalog:read</code>, <code>reservation:write</code>, <code>inventory:hold</code>, <code>order:write</code>, <code>payment:capture</code>, <code>ticket:checkin</code>, <code>reviews.write</code>, <code>reviews.moderate</code>, <code>support.write</code>, <code>support.manage</code> contrôlés à la passerelle et au service.</li>
</ul>
<h3 id="vérification-côté-services-resource-servers">Vérification côté services (Resource Servers) </h3>
<ul>
<li>Validation JWT: vérifier <code>iss</code>, <code>aud</code>, <code>exp/nbf</code>, <code>kid</code> via JWKS (cache + rotation), horloge tolérance 60s.</li>
<li>Contrôle du scope/role: mapping endpoint → scopes/roles requis; refuser 403 si insuffisant.</li>
<li>Multi-défense: vérification à l’API Gateway (OPA/Keycloak authz) et dans chaque service.</li>
<li>Logs d’audit: tracer <code>sub</code>, <code>roles</code>, <code>scope</code>, <code>correlationId</code> par action sensible.</li>
</ul>
<h3 id="service-to-service--webhooks">Service-to-service &amp; webhooks </h3>
<ul>
<li>Inter-services: Client Credentials; chaque service a un client IdP dédié et des scopes stricts (p. ex. <code>reservation-service</code> → <code>inventory:hold</code>).</li>
<li>mTLS optionnel entre services internes pour renforcer l’authenticité côté réseau.</li>
<li>Webhooks PSP: ne pas utiliser Bearer; vérifier signature HMAC du PSP et l’horodatage; rejeter replays (fenêtre courte, nonce).</li>
</ul>
<p>Exemple d’en-têtes webhook:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Stripe-Signature: t=1699970000,v1=abc...,v1=def...
</code></pre><h3 id="sécurité-check-in">Sécurité Check-in </h3>
<ul>
<li>Appareil <code>CHECKIN</code>: tokens très courts (5–15 min), rafraîchissement contrôlé, scope <code>ticket:checkin</code> limité à événements assignés.</li>
<li>Validation scan: la vérification finale se fait côté Ticketing DB (source de vérité) pour éviter les fraudes.</li>
<li>Mode offline: non supporté par défaut. Si imposé, activer un mode dégradé avec cache local (5 min max) et resynchronisation obligatoire.</li>
</ul>
<h3 id="protection-applicative">Protection applicative </h3>
<ul>
<li>CSRF: éviter les cookies non same-site; BFF pattern recommandé si nécessaire.</li>
<li>CORS: restreindre <code>origin</code> aux domaines approuvés; seulement <code>GET,POST,PUT,DELETE</code> requis.</li>
<li>Rate limiting &amp; WAF: au niveau gateway; règles spécifiques pour <code>payments/*</code> et <code>inventory/holds</code>.</li>
<li>Secret management: variables de secrets via vault (KMS/KeyVault), rotation régulière.</li>
<li>PII minimale: ne pas stocker les données cartes; uniquement <code>providerRef</code>/tokens PSP.</li>
</ul>
<hr>
<h2 id="plan-de-déploiement--cicd">Plan de Déploiement &amp; CI/CD </h2>
<h3 id="environnements">Environnements </h3>
<ul>
<li>Dev (local): Docker Compose multi-services, hot-reload, DB locales, broker local. IdP local (Keycloak) ou mocks.</li>
<li>Test/Staging: Kubernetes (namespace dédié), DB managées de test, secrets via SealedSecrets/Vault, review apps par PR.</li>
<li>Prod: Kubernetes HA, autoscaling (HPA), DB managées (PostgreSQL), broker managé, observabilité (logs/metrics/tracing), sauvegardes &amp; restauration.</li>
</ul>
<p>SLOs indicatifs:</p>
<ul>
<li>Catalogue p95 &lt; 300 ms; Saga réservation end-to-end p95 &lt; 5 s.</li>
<li>Disponibilité 99.5% (cours) / 99.9% (si requis), RPO ≤ 15 min, RTO ≤ 30 min.</li>
</ul>
<h3 id="stratégie-de-branchement">Stratégie de branchement </h3>
<ul>
<li>Recommandé: Trunk-Based Development
<ul>
<li>Branches courtes <code>feature/*</code>, PRs petites; <code>main</code> toujours déployable.</li>
<li>Tags SemVer (ex: <code>v1.2.0</code>). Feature flags pour activer progressivement.</li>
</ul>
</li>
<li>Alternative (si imposé): Git Flow simplifié (<code>main</code>, <code>develop</code>, <code>release/*</code>, <code>hotfix/*</code>).</li>
</ul>
<h3 id="versionning--images">Versionning &amp; images </h3>
<ul>
<li>Tags d’image: <code>&lt;service&gt;:&lt;semver&gt;-&lt;shortsha&gt;</code> et <code>&lt;service&gt;:sha-&lt;shortsha&gt;</code>; éviter <code>latest</code> en prod.</li>
<li>Signature &amp; SBOM: Cosign + Syft (attestations SLSA niveau de base).</li>
<li>Registry: GHCR ou Docker Hub privé.</li>
</ul>
<h3 id="pipeline-cicd-première-version">Pipeline CI/CD (première version) </h3>
<p>Étapes communes:</p>
<ul>
<li>Qualité: lint + tests unitaires + couverture (par service).</li>
<li>Build images: Docker Buildx, labels OCI, SBOM, push registry.</li>
<li>Sécurité: Trivy (images) + SAST (selon stack) + vérification licences.</li>
<li>Déploiement:
<ul>
<li>Dev: <code>docker compose -f compose.dev.yaml up -d</code> (local) ou K8s Dev.</li>
<li>Staging/Prod: Helm/Kustomize avec <code>values.{env}.yaml</code>, rolling update, health checks.</li>
</ul>
</li>
</ul>
<h4 id="exemple-github-actions-extrait">Exemple GitHub Actions (extrait) </h4>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> ci
<span class="token key atrule">on</span><span class="token punctuation">:</span>
	<span class="token key atrule">push</span><span class="token punctuation">:</span>
		<span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> main <span class="token punctuation">]</span>
	<span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
		<span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> main <span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
	<span class="token key atrule">test</span><span class="token punctuation">:</span>
		<span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
		<span class="token key atrule">strategy</span><span class="token punctuation">:</span>
			<span class="token key atrule">matrix</span><span class="token punctuation">:</span>
				<span class="token key atrule">service</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> event<span class="token punctuation">,</span> inventory<span class="token punctuation">,</span> catalogue<span class="token punctuation">,</span> reservation<span class="token punctuation">,</span> order<span class="token punctuation">,</span> payment<span class="token punctuation">,</span> ticketing<span class="token punctuation">,</span> notification <span class="token punctuation">]</span>
		<span class="token key atrule">steps</span><span class="token punctuation">:</span>
			<span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4
			<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run unit tests (placeholder)
				<span class="token key atrule">run</span><span class="token punctuation">:</span> echo "Run tests for $<span class="token punctuation">{</span><span class="token punctuation">{</span> matrix.service <span class="token punctuation">}</span><span class="token punctuation">}</span>"

	<span class="token key atrule">docker</span><span class="token punctuation">:</span>
		<span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
		<span class="token key atrule">needs</span><span class="token punctuation">:</span> test
		<span class="token key atrule">permissions</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">contents</span><span class="token punctuation">:</span> read<span class="token punctuation">,</span> <span class="token key atrule">packages</span><span class="token punctuation">:</span> write<span class="token punctuation">,</span> <span class="token key atrule">id-token</span><span class="token punctuation">:</span> write <span class="token punctuation">}</span>
		<span class="token key atrule">steps</span><span class="token punctuation">:</span>
			<span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4
			<span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v3
			<span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/login<span class="token punctuation">-</span>action@v3
				<span class="token key atrule">with</span><span class="token punctuation">:</span>
					<span class="token key atrule">registry</span><span class="token punctuation">:</span> ghcr.io
					<span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> github.actor <span class="token punctuation">}</span><span class="token punctuation">}</span>
					<span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>
			<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build &amp; Push images
				<span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
					for SVC in event inventory catalogue reservation order payment ticketing notification; do 
						docker build -t ghcr.io/${{ github.repository }}-$SVC:${{ github.sha }} ./services/$SVC
						docker push ghcr.io/${{ github.repository }}-$SVC:${{ github.sha }}
					done</span>

	<span class="token key atrule">deploy-staging</span><span class="token punctuation">:</span>
		<span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
		<span class="token key atrule">needs</span><span class="token punctuation">:</span> docker
		<span class="token key atrule">environment</span><span class="token punctuation">:</span> staging
		<span class="token key atrule">if</span><span class="token punctuation">:</span> github.ref == 'refs/heads/main'
		<span class="token key atrule">steps</span><span class="token punctuation">:</span>
			<span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4
			<span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> azure/setup<span class="token punctuation">-</span>kubectl@v4
			<span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> azure/setup<span class="token punctuation">-</span>helm@v4
			<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Helm upgrade
				<span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
					helm upgrade --install micro charts/micro \
						--namespace micro-staging --create-namespace \
						--set image.tag=${{ github.sha }}</span>
</code></pre><h4 id="exemple-gitlab-ci-extrait">Exemple GitLab CI (extrait) </h4>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">stages</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> test<span class="token punctuation">,</span> build<span class="token punctuation">,</span> scan<span class="token punctuation">,</span> deploy <span class="token punctuation">]</span>

<span class="token key atrule">unit:test</span><span class="token punctuation">:</span>
	<span class="token key atrule">stage</span><span class="token punctuation">:</span> test
	<span class="token key atrule">script</span><span class="token punctuation">:</span>
		<span class="token punctuation">-</span> echo "run tests per service"

<span class="token key atrule">docker:build</span><span class="token punctuation">:</span>
	<span class="token key atrule">stage</span><span class="token punctuation">:</span> build
	<span class="token key atrule">script</span><span class="token punctuation">:</span>
		<span class="token punctuation">-</span> docker buildx build <span class="token punctuation">-</span><span class="token punctuation">-</span>push <span class="token punctuation">-</span>t $CI_REGISTRY_IMAGE/event<span class="token punctuation">:</span>$CI_COMMIT_SHA services/event

<span class="token key atrule">deploy:staging</span><span class="token punctuation">:</span>
	<span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
	<span class="token key atrule">when</span><span class="token punctuation">:</span> on_success
	<span class="token key atrule">script</span><span class="token punctuation">:</span>
		<span class="token punctuation">-</span> helm upgrade <span class="token punctuation">-</span><span class="token punctuation">-</span>install micro charts/micro <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace micro<span class="token punctuation">-</span>staging <span class="token punctuation">-</span><span class="token punctuation">-</span>set image.tag=$CI_COMMIT_SHA
</code></pre><h3 id="déploiement-local-compose--squelette">Déploiement local (Compose) — squelette </h3>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.9'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
	<span class="token key atrule">event</span><span class="token punctuation">:</span>
		<span class="token key atrule">build</span><span class="token punctuation">:</span> ./services/event
		<span class="token key atrule">environment</span><span class="token punctuation">:</span>
			<span class="token punctuation">-</span> DATABASE_URL=postgres<span class="token punctuation">:</span>//event<span class="token punctuation">:</span>pass@db<span class="token punctuation">:</span>5432/event
		<span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> db<span class="token punctuation">,</span> broker <span class="token punctuation">]</span>
	<span class="token key atrule">inventory</span><span class="token punctuation">:</span>
		<span class="token key atrule">build</span><span class="token punctuation">:</span> ./services/inventory
		<span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> db<span class="token punctuation">,</span> redis<span class="token punctuation">,</span> broker <span class="token punctuation">]</span>
	<span class="token key atrule">catalogue</span><span class="token punctuation">:</span>
		<span class="token key atrule">build</span><span class="token punctuation">:</span> ./services/catalogue
		<span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> broker <span class="token punctuation">]</span>
	<span class="token key atrule">reservation</span><span class="token punctuation">:</span>
		<span class="token key atrule">build</span><span class="token punctuation">:</span> ./services/reservation
		<span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> db<span class="token punctuation">,</span> redis<span class="token punctuation">,</span> broker <span class="token punctuation">]</span>
	<span class="token key atrule">order</span><span class="token punctuation">:</span>
		<span class="token key atrule">build</span><span class="token punctuation">:</span> ./services/order
		<span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> db<span class="token punctuation">,</span> broker <span class="token punctuation">]</span>
	<span class="token key atrule">payment</span><span class="token punctuation">:</span>
		<span class="token key atrule">build</span><span class="token punctuation">:</span> ./services/payment
		<span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> db<span class="token punctuation">,</span> broker <span class="token punctuation">]</span>
	<span class="token key atrule">ticketing</span><span class="token punctuation">:</span>
		<span class="token key atrule">build</span><span class="token punctuation">:</span> ./services/ticketing
		<span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> db<span class="token punctuation">,</span> broker <span class="token punctuation">]</span>
	<span class="token key atrule">notification</span><span class="token punctuation">:</span>
		<span class="token key atrule">build</span><span class="token punctuation">:</span> ./services/notification
		<span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> broker <span class="token punctuation">]</span>
	<span class="token key atrule">db</span><span class="token punctuation">:</span>
		<span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span><span class="token number">16</span>
		<span class="token key atrule">environment</span><span class="token punctuation">:</span>
			<span class="token punctuation">-</span> POSTGRES_PASSWORD=postgres
		<span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"5432:5432"</span> <span class="token punctuation">]</span>
	<span class="token key atrule">redis</span><span class="token punctuation">:</span>
		<span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span><span class="token number">7</span>
		<span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"6379:6379"</span> <span class="token punctuation">]</span>
	<span class="token key atrule">broker</span><span class="token punctuation">:</span>
		<span class="token key atrule">image</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">:</span>3<span class="token punctuation">-</span>management
		<span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"5672:5672"</span><span class="token punctuation">,</span> <span class="token string">"15672:15672"</span> <span class="token punctuation">]</span>
</code></pre><h3 id="déploiement-k8s-helm--valeurs-clés">Déploiement K8s (Helm) — valeurs clés </h3>
<ul>
<li><code>replicaCount</code> (≥2 en prod), <code>resources</code> (requests/limits), <code>liveness/readiness</code> probes.</li>
<li><code>envFrom</code> secrets, <code>configMap</code> pour config non sensible.</li>
<li><code>hpa</code> activé (CPU/mémoire/QPS); <code>podDisruptionBudget</code>.</li>
<li>Ingress avec TLS; rate limiting sur l’API Gateway.</li>
</ul>
<h3 id="promotion--releases">Promotion &amp; releases </h3>
<ul>
<li>Promotion par tag <code>vX.Y.Z</code>: build images taguées + déploiement prod.</li>
<li>Rollback: <code>helm rollback</code> + stratégie DB (migrations backwards-compatibles, blue-green pour changements cassants).</li>
<li>Changelog automatisé depuis PRs/commits.</li>
</ul>
<h3 id="plan-détaillé--environnements-conteneurisation--configuration">Plan détaillé — Environnements, Conteneurisation &amp; Configuration </h3>
<h4 id="environnements-dev--staging--prod">Environnements (dev / staging / prod) </h4>
<ul>
<li>Dev (local):
<ul>
<li>Docker Compose avec profils (<code>compose.dev.yaml</code>), IdP/Broker/DB locaux.</li>
<li>Gateway: Envoy (JWT filter, rate limiting simple).</li>
<li>Hot reload (montage volumes) et semence de données (scripts <code>seed:*</code>).</li>
<li>Fichiers <code>.env.dev</code> par service pour variables non sensibles.</li>
<li>Commandes utiles:<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code>docker compose <span class="token operator">-</span>f compose<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>yaml up <span class="token operator">-</span>d
docker compose <span class="token operator">-</span>f compose<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>yaml logs <span class="token operator">-</span>f orders
</code></pre></li>
</ul>
</li>
<li>Staging:
<ul>
<li>Kubernetes namespace dédié (<code>micro-staging</code>), DB managées de test, secrets chiffrés (SealedSecrets/Vault).</li>
<li>Gateway: Envoy en Ingress (JWT, rate limiting).</li>
<li>Déploiements automatiques sur <code>main</code> avec tests E2E, contrats, smoke tests.</li>
<li>DNS <code>*.staging.example.com</code>, certificats TLS (Let’s Encrypt/ACME), rate limiting.</li>
</ul>
</li>
<li>Production:
<ul>
<li>Cluster K8s HA (multi-AZ), HPA + PDB, sauvegardes DB, politiques de restauration testées.</li>
<li>Gateway: Envoy (JWT, rate limiting, WAF léger si requis).</li>
<li>Déploiement progressif (canary/blue-green), approbation manuelle, fenêtres de maintenance.</li>
<li>Surveillance SLO + alertes, runbooks d’incident, drill de rollback.</li>
</ul>
</li>
</ul>
<h4 id="conteneurisation-docker">Conteneurisation (Docker) </h4>
<ul>
<li>Principes:
<ul>
<li>Images minimales, multi-stage, non-root (<code>USER 10001</code>), base images taguées (sha digest si possible).</li>
<li>Cache Docker optimisé (ordre des <code>COPY</code>), <code>.dockerignore</code> exhaustif, healthcheck.</li>
<li>Variables via env, pas de secrets dans l’image.</li>
</ul>
</li>
<li>Exemple Dockerfile (Node.js)<pre data-role="codeBlock" data-info="dockerfile" class="language-dockerfile dockerfile"><code><span class="token comment"># build</span>
<span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> node:20-alpine <span class="token keyword keyword-AS">AS</span> build</span>
<span class="token instruction"><span class="token keyword keyword-WORKDIR">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> package*.json ./</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> npm ci --omit=dev=false</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> npm run build</span>

<span class="token comment"># runtime</span>
<span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> gcr.io/distroless/nodejs20-debian12</span>
<span class="token instruction"><span class="token keyword keyword-WORKDIR">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword keyword-ENV">ENV</span> NODE_ENV=production</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /app/node_modules ./node_modules</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /app/dist ./dist</span>
<span class="token instruction"><span class="token keyword keyword-USER">USER</span> 10001</span>
<span class="token instruction"><span class="token keyword keyword-EXPOSE">EXPOSE</span> 8080</span>
<span class="token instruction"><span class="token keyword keyword-CMD">CMD</span> [<span class="token string">"/app/dist/main.js"</span>]</span>
</code></pre></li>
<li>Exemple Dockerfile (Spring Boot)<pre data-role="codeBlock" data-info="dockerfile" class="language-dockerfile dockerfile"><code><span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> maven:3.9-eclipse-temurin-21 <span class="token keyword keyword-AS">AS</span> build</span>
<span class="token instruction"><span class="token keyword keyword-WORKDIR">WORKDIR</span> /src</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> pom.xml .</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> mvn -q -e -B -DskipTests package || true</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> mvn -q -e -B -DskipTests package</span>

<span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> eclipse-temurin:21-jre-alpine</span>
<span class="token instruction"><span class="token keyword keyword-ENV">ENV</span> JAVA_OPTS=<span class="token string">"-XX:+UseG1GC -XX:MaxRAMPercentage=75"</span></span>
<span class="token instruction"><span class="token keyword keyword-WORKDIR">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /src/target/*.jar app.jar</span>
<span class="token instruction"><span class="token keyword keyword-USER">USER</span> 10001</span>
<span class="token instruction"><span class="token keyword keyword-EXPOSE">EXPOSE</span> 8080</span>
<span class="token instruction"><span class="token keyword keyword-ENTRYPOINT">ENTRYPOINT</span> [<span class="token string">"sh"</span>,<span class="token string">"-c"</span>,<span class="token string">"java $JAVA_OPTS -jar app.jar"</span>]</span>
</code></pre></li>
</ul>
<h4 id="kubernetes-manifests--helm">Kubernetes (manifests &amp; Helm) </h4>
<ul>
<li>Bonnes pratiques Pods:
<ul>
<li><code>resources</code> (requests/limits), <code>liveness</code>/<code>readiness</code>, <code>startupProbe</code> pour JVM.</li>
<li><code>securityContext</code> (non-root, fsGroup), <code>podDisruptionBudget</code>, <code>topologySpreadConstraints</code>.</li>
<li><code>terminationGracePeriodSeconds</code> + <code>preStop</code> pour drainage.</li>
</ul>
</li>
<li>Réseau/sécurité:
<ul>
<li><code>NetworkPolicy</code> par namespace, Ingress TLS uniquement, secrets <code>Opaque</code>/<code>kubernetes.io/tls</code>.</li>
<li>ImagePolicy (admission) + signatures (Cosign), Gatekeeper/OPA pour règles.</li>
</ul>
</li>
<li>Exemple Deployment (extrait):<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
	<span class="token key atrule">name</span><span class="token punctuation">:</span> order
	<span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">app</span><span class="token punctuation">:</span> order <span class="token punctuation">}</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
	<span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
	<span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token punctuation">}</span>
	<span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">app</span><span class="token punctuation">:</span> order <span class="token punctuation">}</span> <span class="token punctuation">}</span>
	<span class="token key atrule">template</span><span class="token punctuation">:</span>
		<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
			<span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">app</span><span class="token punctuation">:</span> order <span class="token punctuation">}</span>
		<span class="token key atrule">spec</span><span class="token punctuation">:</span>
			<span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>sa
			<span class="token key atrule">containers</span><span class="token punctuation">:</span>
			<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> order
				<span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/org/repo<span class="token punctuation">-</span>order<span class="token punctuation">:</span>sha<span class="token punctuation">-</span>&lt;shortsha<span class="token punctuation">&gt;</span>
				<span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
				<span class="token key atrule">envFrom</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>config <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token key atrule">secretRef</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>secrets <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
				<span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"200m"</span><span class="token punctuation">,</span> <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"256Mi"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token key atrule">limits</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"512Mi"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
				<span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">httpGet</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /health/ready<span class="token punctuation">,</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>
				<span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>  <span class="token punctuation">{</span> <span class="token key atrule">httpGet</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /health/live<span class="token punctuation">,</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
</code></pre></li>
</ul>
<h4 id="configuration-externalisée-12-factor">Configuration externalisée (12-Factor) </h4>
<ul>
<li>Hiérarchie: env vars &gt; Secrets/ConfigMaps &gt; defaults.</li>
<li>ConfigMaps pour non-sensible, Secrets pour credentials/keys (chiffrés au repos via KMS/CSI).</li>
<li><code>.env.*</code> seulement en dev local; jamais commiter secrets.</li>
<li>Exemple ConfigMap/Secret:<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>config <span class="token punctuation">}</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
	<span class="token key atrule">APP_ENV</span><span class="token punctuation">:</span> staging
	<span class="token key atrule">CATALOG_URL</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//catalogue.staging.example.com
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>secrets <span class="token punctuation">}</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">stringData</span><span class="token punctuation">:</span>
	<span class="token key atrule">DATABASE_URL</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>//order<span class="token punctuation">:</span><span class="token important">***@db:5432/order</span>
	<span class="token key atrule">OIDC_JWKS_URI</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//idp.example.com/.well<span class="token punctuation">-</span>known/jwks.json
</code></pre></li>
</ul>
<h4 id="helm--kustomize">Helm / Kustomize </h4>
<ul>
<li>Structure recommandée: chart par service + umbrella chart pour l’ensemble.</li>
<li>Valeurs par environnement:
<ul>
<li><code>values.dev.yaml</code> (répliques 1, logs verbeux), <code>values.staging.yaml</code> (répliques 2, probes strictes), <code>values.prod.yaml</code> (répliques 3+, HPA activé).</li>
</ul>
</li>
<li>Exemple valeurs (extrait):<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">image</span><span class="token punctuation">:</span>
	<span class="token key atrule">repository</span><span class="token punctuation">:</span> ghcr.io/org/repo<span class="token punctuation">-</span>order
	<span class="token key atrule">tag</span><span class="token punctuation">:</span> sha<span class="token punctuation">-</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.gitSha <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">resources</span><span class="token punctuation">:</span>
	<span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m<span class="token punctuation">,</span> <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi <span class="token punctuation">}</span>
	<span class="token key atrule">limits</span><span class="token punctuation">:</span>   <span class="token punctuation">{</span> <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>  <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi <span class="token punctuation">}</span>
<span class="token key atrule">ingress</span><span class="token punctuation">:</span>
	<span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
	<span class="token key atrule">host</span><span class="token punctuation">:</span> order.staging.example.com
	<span class="token key atrule">tls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">env</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CATALOG_URL
		<span class="token key atrule">value</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//catalogue.staging.example.com
</code></pre></li>
</ul>
<h4 id="pipeline-cicd-détaillé">Pipeline CI/CD (détaillé) </h4>
<ul>
<li>Étapes et gates:
<ol>
<li>Lint/Type-check/Unit Tests (fail-fast)</li>
<li>Build images + SBOM (Syft) + signature (Cosign)</li>
<li>Scans SAST/Container (Trivy/CodeQL) — gate</li>
<li>Contrats (Pact) Provider/Consumer — gate</li>
<li>Integration tests (Testcontainers) — gate</li>
<li>Deploy Staging (Helm) + Smoke tests + E2E — gate</li>
<li>Approve → Prod (manual) → Canary 10% → 50% → 100% + rollback auto si SLO violés</li>
<li>Post-deploy checks: migrations ok, DLQ vide, erreurs &lt; seuil</li>
</ol>
</li>
<li>Commandes de base:<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code>helm upgrade <span class="token operator">--</span>install micro charts/micro <span class="token operator">--</span>namespace micro-staging <span class="token operator">--</span>create-namespace `
	<span class="token operator">-</span>f charts/micro/values<span class="token punctuation">.</span>staging<span class="token punctuation">.</span>yaml <span class="token operator">--</span><span class="token function">set</span> image<span class="token punctuation">.</span>tag=<span class="token variable">$env</span>:GITHUB_SHA

helm upgrade <span class="token operator">--</span>install micro charts/micro <span class="token operator">--</span>namespace micro-prod `
	<span class="token operator">-</span>f charts/micro/values<span class="token punctuation">.</span>prod<span class="token punctuation">.</span>yaml <span class="token operator">--</span><span class="token function">set</span> image<span class="token punctuation">.</span>tag=<span class="token variable">$env</span>:GITHUB_SHA
</code></pre></li>
</ul>
<h4 id="migrations-base-de-données">Migrations base de données </h4>
<ul>
<li>Outil: Flyway/Liquibase par service; exécution en <code>initContainer</code> ou Job pré-déploiement.</li>
<li>Règles: migrations backward-compatibles, feature toggles pour accès code, rollback scripts si possible.</li>
</ul>
<h4 id="progressive-delivery--gitops-optionnel">Progressive Delivery &amp; GitOps (optionnel) </h4>
<ul>
<li>Canary/Blue-Green via ServiceMesh (Istio/Linkerd) ou ingress canary annotations.</li>
<li>GitOps: Argo CD/Flux gère sync des manifests; PR → merge → Argo déploie, drift detection et rollback.</li>
</ul>
<hr>
<h2 id="modélisation-des-événements">Modélisation des Événements </h2>
<p>Toutes les publications respectent l’enveloppe CloudEvents décrite plus haut (<code>type</code>, <code>id</code>, <code>source</code>, <code>time</code>, <code>correlationId</code>, <code>data</code>). Ci-dessous, la liste des événements asynchrones avec payload <code>data</code>, producteur et consommateurs.</p>
<h3 id="liste-des-événements-par-domaine">Liste des événements (par domaine) </h3>
<ol>
<li>Event Service</li>
</ol>
<ul>
<li><code>event.created</code>
<ul>
<li>Producteur: Event Service; Consommateurs: Catalogue, Inventory</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"eventId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"title"</span><span class="token operator">:</span><span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token property">"ownerId"</span><span class="token operator">:</span><span class="token string">"uuid"</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>event.published</code>
<ul>
<li>Producteur: Event Service; Consommateurs: Catalogue, Inventory</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"eventId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"publishedAt"</span><span class="token operator">:</span><span class="token string">"ISO-8601"</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>performance.scheduled</code>
<ul>
<li>Producteur: Event Service; Consommateurs: Catalogue, Inventory, Reservation</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"eventId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"startTime"</span><span class="token operator">:</span><span class="token string">"ISO-8601"</span><span class="token punctuation">,</span> <span class="token property">"venueId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"pricingSchemeId"</span><span class="token operator">:</span><span class="token string">"uuid"</span> <span class="token punctuation">}</span>
</code></pre></li>
</ul>
<ol start="2">
<li>Inventory Service</li>
</ol>
<ul>
<li><code>capacity.adjusted</code>
<ul>
<li>Producteur: Inventory; Consommateurs: Catalogue</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"bucketId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"remaining"</span><span class="token operator">:</span><span class="token number">123</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>seats.reserved</code>
<ul>
<li>Producteur: Inventory; Consommateurs: Reservation (pour projection/monitoring), Catalogue (optionnel)</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"holdId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"seats"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"A-12"</span><span class="token punctuation">,</span><span class="token string">"A-13"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"buckets"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"bucketId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span><span class="token property">"qty"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"expiresAt"</span><span class="token operator">:</span><span class="token string">"ISO-8601"</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>seats.released</code>
<ul>
<li>Producteur: Inventory; Consommateurs: Reservation, Catalogue</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"holdId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"seats"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"A-12"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"buckets"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"bucketId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span><span class="token property">"qty"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre></li>
</ul>
<ol start="3">
<li>Reservation Service</li>
</ol>
<ul>
<li><code>reservation.started</code>
<ul>
<li>Producteur: Reservation; Consommateurs: Analytics/Monitoring (optionnel)</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"reservationId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"customerId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"expiresAt"</span><span class="token operator">:</span><span class="token string">"ISO-8601"</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>reservation.item.added</code>
<ul>
<li>Producteur: Reservation; Consommateurs: Analytics (optionnel)</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"reservationId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"seatId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"bucketId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"qty"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"unitPrice"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"39.00"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>reservation.confirmed</code>
<ul>
<li>Producteur: Reservation; Consommateurs: Order</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"reservationId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"customerId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"78.00"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>reservation.expired</code> | <code>reservation.cancelled</code>
<ul>
<li>Producteur: Reservation; Consommateurs: Inventory (pour libération si nécessaire), Catalogue (optionnel)</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"reservationId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"reason"</span><span class="token operator">:</span><span class="token string">"expired|user_cancelled|payment_failed"</span> <span class="token punctuation">}</span>
</code></pre></li>
</ul>
<ol start="4">
<li>Order Service</li>
</ol>
<ul>
<li><code>order.placed</code>
<ul>
<li>Producteur: Order; Consommateurs: Payment, Notification (optionnel)</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"reservationId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"customerId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"78.00"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>order.paid</code>
<ul>
<li>Producteur: Order; Consommateurs: Ticketing, Notification</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"paidAt"</span><span class="token operator">:</span><span class="token string">"ISO-8601"</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>order.cancelled</code> | <code>order.refunded</code>
<ul>
<li>Producteur: Order; Consommateurs: Notification, Catalogue (optionnel)</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"reason"</span><span class="token operator">:</span><span class="token string">"payment_failed|user_request|event_cancelled"</span> <span class="token punctuation">}</span>
</code></pre></li>
</ul>
<ol start="5">
<li>Payment Service</li>
</ol>
<ul>
<li><code>payment.captured</code>
<ul>
<li>Producteur: Payment; Consommateurs: Order, Notification</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"paymentId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"78.00"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>payment.failed</code>
<ul>
<li>Producteur: Payment; Consommateurs: Order</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"paymentId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"failureReason"</span><span class="token operator">:</span><span class="token string">"insufficient_funds|declined|timeout"</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>payment.refunded</code>
<ul>
<li>Producteur: Payment; Consommateurs: Order (pour marquer remboursé), Notification</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"paymentId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"amount"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"currency"</span><span class="token operator">:</span><span class="token string">"EUR"</span><span class="token punctuation">,</span><span class="token property">"amount"</span><span class="token operator">:</span><span class="token string">"20.00"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre></li>
</ul>
<ol start="6">
<li>Ticketing Service</li>
</ol>
<ul>
<li><code>ticket.issued</code>
<ul>
<li>Producteur: Ticketing; Consommateurs: Notification</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"tickets"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"ticketId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span><span class="token property">"performanceId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span><span class="token property">"seatId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>ticket.checked_in</code>
<ul>
<li>Producteur: Ticketing; Consommateurs: Analytics/Monitoring (optionnel)</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"ticketId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"checkedInAt"</span><span class="token operator">:</span><span class="token string">"ISO-8601"</span><span class="token punctuation">,</span> <span class="token property">"deviceId"</span><span class="token operator">:</span><span class="token string">"string"</span> <span class="token punctuation">}</span>
</code></pre></li>
<li><code>ticket.revoked</code>
<ul>
<li>Producteur: Ticketing; Consommateurs: Notification</li>
<li><code>data</code>:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span> <span class="token property">"ticketId"</span><span class="token operator">:</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> <span class="token property">"reason"</span><span class="token operator">:</span><span class="token string">"refund|fraud|event_cancelled"</span> <span class="token punctuation">}</span>
</code></pre></li>
</ul>
<hr>
<h3 id="topologie-broker-rabbitmq">Topologie Broker (RabbitMQ) </h3>
<ul>
<li>Exchange principal: <code>domain.events</code> (type <code>topic</code>, durable: true)</li>
<li>Routing keys: <code>&lt;service&gt;.&lt;entity&gt;.&lt;event&gt;</code> (ex: <code>event.performance.scheduled</code>, <code>inventory.seats.reserved</code>)</li>
</ul>
<p>Queues et bindings (exemples):</p>
<ul>
<li><code>catalogue.q</code>
<ul>
<li>Bindings: <code>event.*.*</code>, <code>inventory.capacity.adjusted</code>, <code>inventory.seats.*</code></li>
</ul>
</li>
<li><code>order.q</code>
<ul>
<li>Bindings: <code>reservation.confirmed</code>, <code>payment.captured</code>, <code>payment.failed</code>, <code>payment.refunded</code></li>
</ul>
</li>
<li><code>ticketing.q</code>
<ul>
<li>Bindings: <code>order.paid</code></li>
</ul>
</li>
<li><code>notification.q</code>
<ul>
<li>Bindings: <code>ticket.issued</code>, <code>order.paid</code>, <code>payment.refunded</code>, <code>order.refunded</code></li>
</ul>
</li>
<li><code>reservation.q</code> (optionnel pour projections internes)
<ul>
<li>Bindings: <code>inventory.seats.*</code></li>
</ul>
</li>
</ul>
<p>Déclaration (extrait YAML):</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">exchanges</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> domain.events
		<span class="token key atrule">type</span><span class="token punctuation">:</span> topic
		<span class="token key atrule">durable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">queues</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> catalogue.q
		<span class="token key atrule">durable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
		<span class="token key atrule">bindings</span><span class="token punctuation">:</span>
			<span class="token punctuation">-</span> <span class="token key atrule">exchange</span><span class="token punctuation">:</span> domain.events
				<span class="token key atrule">routing_key</span><span class="token punctuation">:</span> <span class="token string">'event.*.*'</span>
			<span class="token punctuation">-</span> <span class="token key atrule">exchange</span><span class="token punctuation">:</span> domain.events
				<span class="token key atrule">routing_key</span><span class="token punctuation">:</span> <span class="token string">'inventory.capacity.adjusted'</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> order.q
		<span class="token key atrule">durable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
		<span class="token key atrule">bindings</span><span class="token punctuation">:</span>
			<span class="token punctuation">-</span> <span class="token key atrule">exchange</span><span class="token punctuation">:</span> domain.events
				<span class="token key atrule">routing_key</span><span class="token punctuation">:</span> <span class="token string">'reservation.confirmed'</span>
			<span class="token punctuation">-</span> <span class="token key atrule">exchange</span><span class="token punctuation">:</span> domain.events
				<span class="token key atrule">routing_key</span><span class="token punctuation">:</span> <span class="token string">'payment.*'</span>
</code></pre><h3 id="idempotence-retries-et-dlq">Idempotence, retries et DLQ </h3>
<ul>
<li>Outbox producteur: chaque service persiste l’événement avec l’agrégat, puis un publisher fiable poste sur <code>domain.events</code>. <code>id</code> unique (UUID) par événement.</li>
<li>Idempotence consommateur: table <code>processed_events</code> par service pour dédupliquer.</li>
</ul>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> processed_events <span class="token punctuation">(</span>
	event_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	source <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	received_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ul>
<li>At-least-once: les consommateurs valident (ack) uniquement après traitement + insertion <code>processed_events</code> atomique.</li>
<li>Retries: pour chaque queue <code>*.q</code>, créer une <code>*.retry.q</code> (TTL 30s/2min) avec <code>x-dead-letter-exchange: domain.events</code> et redirection vers la queue d’origine via une clé de retry (ou via un exchange dédié).</li>
<li>DLQ: <code>*.dlq</code> par queue avec <code>x-dead-letter-exchange</code> configuré; messages échoués N fois (ex: 5) vont en DLQ pour inspection.</li>
</ul>
<p>Déclaration (extrait RabbitMQ):</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">queues</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> order.q
		<span class="token key atrule">durable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
		<span class="token key atrule">arguments</span><span class="token punctuation">:</span>
			<span class="token key atrule">x-dead-letter-exchange</span><span class="token punctuation">:</span> domain.dlx
			<span class="token key atrule">x-dead-letter-routing-key</span><span class="token punctuation">:</span> order.retry
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> order.retry.q
		<span class="token key atrule">durable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
		<span class="token key atrule">arguments</span><span class="token punctuation">:</span>
			<span class="token key atrule">x-message-ttl</span><span class="token punctuation">:</span> <span class="token number">30000</span>
			<span class="token key atrule">x-dead-letter-exchange</span><span class="token punctuation">:</span> domain.events
			<span class="token key atrule">x-dead-letter-routing-key</span><span class="token punctuation">:</span> order
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> order.dlq
		<span class="token key atrule">durable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">bindings</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">exchange</span><span class="token punctuation">:</span> domain.events
		<span class="token key atrule">queue</span><span class="token punctuation">:</span> order.q
		<span class="token key atrule">routing_key</span><span class="token punctuation">:</span> <span class="token string">'reservation.confirmed'</span>
	<span class="token punctuation">-</span> <span class="token key atrule">exchange</span><span class="token punctuation">:</span> domain.dlx
		<span class="token key atrule">queue</span><span class="token punctuation">:</span> order.retry.q
		<span class="token key atrule">routing_key</span><span class="token punctuation">:</span> <span class="token string">'order.retry'</span>
</code></pre><h3 id="gouvernance-des-schémas">Gouvernance des schémas </h3>
<ul>
<li>Versionner les schémas <code>data</code> (champ <code>schemaVersion</code> facultatif) et documenter les changements compatibles.</li>
<li>Valider les payloads via JSON Schema à l’émission et à la consommation (logs + rejet vers DLQ en cas d’incompatibilité).</li>
</ul>
<hr>
<h2 id="conception-des-sagas--circuit-breakers">Conception des Sagas &amp; Circuit Breakers </h2>
<p>Cette section détaille précisément les sagas (états, messages, compensations) et les points d’application des Circuit Breakers avec seuils.</p>
<h3 id="saga-1--réservation--commande--paiement--billets">Saga 1 — Réservation → Commande → Paiement → Billets </h3>
<p>State machine (vue simplifiée):</p>
<div class="mermaid">stateDiagram-v2
  [*] --&gt; Pending
  Pending --&gt; SeatsHeld: ReserveSeats OK (sync)
  Pending --&gt; Failed: ReserveSeats KO
  SeatsHeld --&gt; OrderPlaced: reservation.confirmed
  OrderPlaced --&gt; Paid: payment.captured
  Paid --&gt; TicketsIssued: ticket.issued
  SeatsHeld --&gt; Expired: TTL reached (reservation.expired)
  OrderPlaced --&gt; Cancelled: payment.failed | timeout
  TicketsIssued --&gt; [*]
  Expired --&gt; [*]
  Cancelled --&gt; [*]
  Failed --&gt; [*]
</div><p>Déroulé précis (avec compensations):</p>
<ol>
<li>StartReservation (Reservation)
<ul>
<li>Transaction locale: créer <code>Reservation(pending)</code> avec <code>expiresAt</code>.</li>
<li>Message: <code>reservation.started</code> (optionnel analytics).</li>
<li>Timeout: n/a.</li>
<li>Compensation: n/a.</li>
</ul>
</li>
<li>AddItem → ReserveSeats (sync) (Reservation → Inventory)
<ul>
<li>Transaction locale Inventory: allouer sièges / décrémenter bucket; créer <code>holdId</code> (TTL).</li>
<li>Réponse: OK → <code>SeatsHeld</code>; KO → <code>Failed</code> (OutOfStock).</li>
<li>Compensation: si KO, aucune; si plus tard rollback, appeler <code>ReleaseSeats(holdId)</code>.</li>
</ul>
</li>
<li>ConfirmReservation (Reservation)
<ul>
<li>Transaction locale: <code>Reservation.confirmed</code>.</li>
<li>Message: <code>reservation.confirmed</code> → Order (ou appel API <code>POST /orders</code>).</li>
<li>Compensation: si échec ultérieur, publier <code>reservation.cancelled</code> et <code>ReleaseSeats</code>.</li>
</ul>
</li>
<li>PlaceOrder (Order)
<ul>
<li>Transaction locale: créer <code>Order(pending)</code>; outbox <code>order.placed</code>.</li>
<li>Appel sync: <code>Payment.createIntent/capture</code>.</li>
<li>Timeout: 1s (voir breakers ci-dessous); en cas de timeout, marquer <code>Order(pending|processing)</code> et attendre webhook.</li>
<li>Compensation: si <code>payment.failed</code>, marquer <code>order.cancelled</code> et appeler <code>ReleaseSeats</code>.</li>
</ul>
</li>
<li>CapturePayment (Payment)
<ul>
<li>Transaction locale: <code>Payment(captured)</code>; outbox <code>payment.captured</code>.</li>
<li>Compensation: si capture multiple, idempotence retourne même résultat; si remboursement nécessaire, publier <code>payment.refunded</code>.</li>
</ul>
</li>
<li>MarkPaid (Order)
<ul>
<li>Transaction locale: <code>Order(paid)</code>; outbox <code>order.paid</code>.</li>
<li>Compensation: en cas d’échec d’émission des billets, déclencher remboursement ou workflow de correction.</li>
</ul>
</li>
<li>IssueTickets (Ticketing)
<ul>
<li>Transaction locale: créer tickets + QR; outbox <code>ticket.issued</code>.</li>
<li>Compensation: si besoin d’annuler, <code>ticket.revoked</code> + <code>payment.refunded</code>.</li>
</ul>
</li>
</ol>
<p>Compensations clés:</p>
<ul>
<li>ReleaseSeats(holdId) si réservation expirée/annulée ou paiement échoué.</li>
<li>CancelOrder si paiement KO/timeout prolongé.</li>
<li>RefundPayment si billets non émis après paiement (ou annulation organisateur).</li>
<li>RevokeTickets si remboursement post-émission.</li>
</ul>
<p>Timeouts de référence:</p>
<ul>
<li>Inventory Reserve/Release: 300–500 ms (p95), retry 2 avec backoff 50→150 ms (idempotent).</li>
<li>Payment capture: 1–2 s; retry 0–1 (seulement timeout réseau), s’appuyer sur webhook pour l’issue finale.</li>
<li>Ticket issue: 500 ms; en cas d’échec, file d’attente interne + retry.</li>
</ul>
<h3 id="saga-2--annulation--remboursement-post-paiement">Saga 2 — Annulation &amp; Remboursement (post-paiement) </h3>
<p>Cas d’usage: annulation par utilisateur avant l’événement, ou annulation d’événement par l’organisateur.</p>
<p>Étapes:</p>
<ol>
<li>RequestCancel (Order)
<ul>
<li>Préconditions: <code>Order(paid)</code>; politique de remboursement appliquée.</li>
<li>Message: <code>order.refund.requested</code> (interne) → Payment.</li>
</ul>
</li>
<li>Refund (Payment)
<ul>
<li>Transaction locale: créer <code>Refund(pending)</code> puis <code>succeeded</code> via PSP; outbox <code>payment.refunded</code>.</li>
<li>Compensation: si refund KO, <code>refund.failed</code> → support manuel.</li>
</ul>
</li>
<li>MarkRefunded (Order)
<ul>
<li>Transaction locale: <code>Order(refunded)</code>; outbox <code>order.refunded</code>.</li>
</ul>
</li>
<li>RevokeTickets (Ticketing)
<ul>
<li>Transaction locale: <code>ticket.revoked</code>.</li>
</ul>
</li>
<li>ReleaseSeats (Inventory)
<ul>
<li>Si applicable (sièges encore réservés pour une performance future), libérer capacité.</li>
</ul>
</li>
<li>Notify (Notification)
<ul>
<li>Envoi confirmation au client.</li>
</ul>
</li>
</ol>
<h3 id="circuit-breakers--points-dapplication-et-seuils">Circuit Breakers — Points d’application et seuils </h3>
<p>Appliquer des Circuit Breakers uniquement sur appels synchrones. Le flux événementiel est protégé via retries/DLQ, pas par CB.</p>
<p>Points critiques:</p>
<ul>
<li>Reservation → Inventory (Reserve/Release)
<ul>
<li>timeouts: 300 ms</li>
<li>retries: 2 (backoff exponentiel 50→150 ms)</li>
<li>breaker: failureRateThreshold 50% sur 20 appels min; slowCallDurationThreshold 250 ms; slowCallRateThreshold 70%</li>
<li>openState: 10 s; halfOpen: 5 appels permis; automaticTransition: true</li>
</ul>
</li>
<li>Order → Payment (create/capture)
<ul>
<li>timeouts: 1 s</li>
<li>retries: 0 (préférer webhook), 1 si timeout réseau strictement idempotent</li>
<li>breaker: failureRateThreshold 30% sur 50 appels; slowCallDurationThreshold 800 ms; open 30 s; halfOpen 10</li>
<li>fallback: marquer <code>Order(processing)</code> et attendre webhook PSP</li>
</ul>
</li>
<li>Payment → PSP (externe)
<ul>
<li>timeouts: 2 s</li>
<li>retries: 2 (timeouts/transient), backoff 200→800 ms, jitter</li>
<li>breaker: failureRateThreshold 25% sur 50 appels; open 45 s; halfOpen 10</li>
<li>fallback: status <code>processing</code>; écoute des webhooks + job de réconciliation</li>
</ul>
</li>
<li>Ticketing → Storage (PDF/objet) [si sync]
<ul>
<li>timeouts: 500 ms; retries: 2</li>
<li>breaker: failureRateThreshold 50% / 20 appels; open 15 s</li>
<li>fallback: file interne pour (re)génération asynchrone</li>
</ul>
</li>
</ul>
<p>Resilience4j (exemple de config YAML):</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">resilience4j</span><span class="token punctuation">:</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
	 <span class="token key atrule">instances</span><span class="token punctuation">:</span>
		<span class="token key atrule">rsv_inventory</span><span class="token punctuation">:</span>
		  <span class="token key atrule">slidingWindowType</span><span class="token punctuation">:</span> COUNT_BASED
		  <span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> <span class="token number">20</span>
		  <span class="token key atrule">minimumNumberOfCalls</span><span class="token punctuation">:</span> <span class="token number">20</span>
		  <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">50</span>
		  <span class="token key atrule">slowCallRateThreshold</span><span class="token punctuation">:</span> <span class="token number">70</span>
		  <span class="token key atrule">slowCallDurationThreshold</span><span class="token punctuation">:</span> 250ms
		  <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> 10s
		  <span class="token key atrule">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">5</span>
		  <span class="token key atrule">automaticTransitionFromOpenToHalfOpenEnabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
		<span class="token key atrule">ord_payment</span><span class="token punctuation">:</span>
		  <span class="token key atrule">slidingWindowType</span><span class="token punctuation">:</span> COUNT_BASED
		  <span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> <span class="token number">50</span>
		  <span class="token key atrule">minimumNumberOfCalls</span><span class="token punctuation">:</span> <span class="token number">30</span>
		  <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">30</span>
		  <span class="token key atrule">slowCallDurationThreshold</span><span class="token punctuation">:</span> 800ms
		  <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> 30s
		  <span class="token key atrule">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">timelimiter</span><span class="token punctuation">:</span>
	 <span class="token key atrule">instances</span><span class="token punctuation">:</span>
		<span class="token key atrule">rsv_inventory</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> 300ms <span class="token punctuation">}</span>
		<span class="token key atrule">ord_payment</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> 1s <span class="token punctuation">}</span>
		<span class="token key atrule">pay_psp</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> 2s <span class="token punctuation">}</span>
  <span class="token key atrule">retry</span><span class="token punctuation">:</span>
	 <span class="token key atrule">instances</span><span class="token punctuation">:</span>
		<span class="token key atrule">rsv_inventory</span><span class="token punctuation">:</span>
		  <span class="token key atrule">maxAttempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
		  <span class="token key atrule">waitDuration</span><span class="token punctuation">:</span> 50ms
		  <span class="token key atrule">enableExponentialBackoff</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
		  <span class="token key atrule">exponentialBackoffMultiplier</span><span class="token punctuation">:</span> <span class="token number">2.0</span>
		  <span class="token key atrule">retryExceptions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> java.net.SocketTimeoutException<span class="token punctuation">,</span> java.io.IOException <span class="token punctuation">]</span>
		<span class="token key atrule">pay_psp</span><span class="token punctuation">:</span>
		  <span class="token key atrule">maxAttempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
		  <span class="token key atrule">waitDuration</span><span class="token punctuation">:</span> 200ms
		  <span class="token key atrule">enableExponentialBackoff</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
		  <span class="token key atrule">exponentialBackoffMultiplier</span><span class="token punctuation">:</span> <span class="token number">2.0</span>
</code></pre><p>Observabilité &amp; tuning:</p>
<ul>
<li>Exporter métriques CB (ouvert/fermé, failure rate) et timeouts; alertes si CB ouvert &gt; 2 min.</li>
<li>Corréler avec p95/p99 de chaque appel; ajuster <code>slowCallDurationThreshold</code> en fonction des SLOs.</li>
</ul>
<hr>
<h2 id="conception-de-la-sécurité--détails-auth--rôles">Conception de la Sécurité — Détails Auth &amp; Rôles </h2>
<p>Cette section précise le schéma d’authentification, la gestion des rôles, les flux de connexion/inscription et la vérification des jetons au niveau de la Gateway et des services.</p>
<h3 id="choix-dauthentification">Choix d’authentification </h3>
<ul>
<li>OIDC/OAuth2 avec Authorization Code + PKCE (utilisateur final).</li>
<li>Client Credentials pour service-à-service (backends et jobs).</li>
<li>Jetons: <code>id_token</code> (UX), <code>access_token</code> (JWT pour API), <code>refresh_token</code> (rotation).</li>
<li>TTL recommandés: access 10–15 min, refresh 7–30 jours (rotation + revocation).</li>
</ul>
<h3 id="rôles--scopes-rbacabac">Rôles &amp; Scopes (RBAC/ABAC) </h3>
<ul>
<li>Rôles (RBAC): <code>CUSTOMER</code>, <code>ORGANIZER</code>, <code>CHECKIN</code>, <code>ADMIN</code>.</li>
<li>Scopes API (exemples): <code>catalog.read</code>, <code>order.write</code>, <code>payment.refund</code>, <code>ticket.checkin</code>.</li>
<li>ABAC: règles d’appartenance/tenancy (ex. <code>resource.owner == sub</code> ou <code>orgId</code> égal), appliquées au niveau service.</li>
<li>Mapping de rôle → permissions par service (ex.):
<ul>
<li><code>CUSTOMER</code>: réserver/payer ses commandes, lister ses tickets.</li>
<li><code>ORGANIZER</code>: créer événements, gérer inventaire/pricing de ses événements.</li>
<li><code>CHECKIN</code>: vérifier/valider tickets d’un événement assigné.</li>
<li><code>ADMIN</code>: opérations globales et gestion des rôles.</li>
</ul>
</li>
</ul>
<h3 id="flux-dinscription-signup">Flux d’inscription (signup) </h3>
<div class="mermaid">sequenceDiagram
	participant UI as Frontend
	participant IDP as Identity Provider (OIDC)
	participant ADM as Admin (backoffice)
	UI-&gt;&gt;IDP: Page d’inscription (hébergée IdP)
	IDP--&gt;&gt;UI: Email de vérification / mot de passe initial
	Note over IDP: Création utilisateur, rôle par défaut CUSTOMER
	ADM-&gt;&gt;IDP: Attribution rôle ORGANIZER/CHECKIN (si approuvé)
</div><p>Alternative: endpoint <code>POST /identity/register</code> (service Identity) qui crée l’utilisateur via l’API admin de l’IdP, puis envoie email de vérification.</p>
<h3 id="flux-de-connexion-login--authorization-code--pkce">Flux de connexion (login) — Authorization Code + PKCE </h3>
<div class="mermaid">sequenceDiagram
	participant UI as SPA/BFF
	participant GW as API Gateway
	participant IDP as OIDC Provider
	participant RS as Resource Service
	UI-&gt;&gt;IDP: /authorize (code + PKCE)
	IDP--&gt;&gt;UI: redirect avec code
	UI-&gt;&gt;IDP: /token (code + verifier)
	IDP--&gt;&gt;UI: id_token + access_token (+ refresh)
	UI-&gt;&gt;GW: Appel API avec Authorization: Bearer &lt;access&gt;
	GW-&gt;&gt;IDP: Récup JWKS (cache TTL)
	GW--&gt;&gt;RS: Requête validée (headers de contexte)
	RS-&gt;&gt;IDP: (optionnel) JWKS/validation locale
	RS--&gt;&gt;UI: Réponse
</div><p>Recommandations</p>
<ul>
<li>SPA: utiliser PKCE, stocker tokens en mémoire; préférer BFF pour cookies HttpOnly Secure + rotation refresh côté serveur.</li>
<li>Rotation des refresh tokens et détection de replays; revocation à la déconnexion.</li>
</ul>
<h3 id="vérification-des-jetons--api-gateway-envoy">Vérification des jetons — API Gateway (Envoy) </h3>
<ul>
<li>Valider <code>access_token</code> JWT via JWKS (cache 5–15 min, invalidation sur <code>kid</code> inconnu).</li>
<li>Vérifications: <code>iss</code>, <code>aud</code>, <code>exp</code>, <code>nbf</code>, <code>iat</code>, alg <code>RS256/ES256</code>.</li>
<li>Politiques par route: rôles/scopes requis, méthodes, rate limit.</li>
<li>Enrichir et propager seulement des entêtes stricts:
<ul>
<li><code>x-user-id</code> (subject), <code>x-tenant-id</code> (si multi-tenant), <code>x-roles</code>, <code>x-scopes</code>, <code>x-correlation-id</code>.</li>
</ul>
</li>
<li>Ne jamais faire confiance aux entêtes venant du client; Gateway les définit.</li>
</ul>
<p>Exemple (Envoy JWT filter):</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">static_resources</span><span class="token punctuation">:</span>
	<span class="token key atrule">listeners</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress
		<span class="token key atrule">filter_chains</span><span class="token punctuation">:</span>
		<span class="token punctuation">-</span> <span class="token key atrule">filters</span><span class="token punctuation">:</span>
			<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> envoy.filters.network.http_connection_manager
				<span class="token key atrule">typed_config</span><span class="token punctuation">:</span>
					<span class="token key atrule">"@type"</span><span class="token punctuation">:</span> type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
					<span class="token key atrule">route_config</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> local_route <span class="token punctuation">}</span>
					<span class="token key atrule">http_filters</span><span class="token punctuation">:</span>
					<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> envoy.filters.http.jwt_authn
						<span class="token key atrule">typed_config</span><span class="token punctuation">:</span>
							<span class="token key atrule">"@type"</span><span class="token punctuation">:</span> type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
							<span class="token key atrule">providers</span><span class="token punctuation">:</span>
								<span class="token key atrule">idp</span><span class="token punctuation">:</span>
									<span class="token key atrule">issuer</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//idp.example.com/
									<span class="token key atrule">remote_jwks</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">http_uri</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//idp.example.com/.well<span class="token punctuation">-</span>known/jwks.json<span class="token punctuation">,</span> <span class="token key atrule">cluster</span><span class="token punctuation">:</span> idp <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token key atrule">cache_duration</span><span class="token punctuation">:</span> 600s <span class="token punctuation">}</span>
									<span class="token key atrule">forward</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
							<span class="token key atrule">rules</span><span class="token punctuation">:</span>
							<span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">"/orders"</span> <span class="token punctuation">}</span>
								<span class="token key atrule">requires</span><span class="token punctuation">:</span>
									<span class="token key atrule">provider_name</span><span class="token punctuation">:</span> idp
					<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> envoy.filters.http.router
</code></pre><h3 id="vérification-des-jetons--services-défense-en-profondeur">Vérification des jetons — Services (défense en profondeur) </h3>
<ul>
<li>Chaque service valide aussi le JWT (ou accepte un jeton d’échange signé par la Gateway).</li>
<li>Extraire <code>sub</code>, <code>roles</code>, <code>scope</code>, <code>orgId</code> et appliquer ABAC (ownership/tenant).</li>
</ul>
<p>Exemple Spring Security (Resource Server):</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Bean</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword keyword-throws">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	http<span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span>oauth <span class="token operator">-&gt;</span> oauth<span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span>auth <span class="token operator">-&gt;</span> auth
				<span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span> <span class="token string">"/orders"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"SCOPE_order.write"</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">"/tickets/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_CUSTOMER"</span><span class="token punctuation">,</span><span class="token string">"ROLE_CHECKIN"</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-return">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span> <span class="token class-name">JwtDecoder</span> <span class="token function">jwtDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-return">return</span> <span class="token class-name">NimbusJwtDecoder</span><span class="token punctuation">.</span><span class="token function">withJwkSetUri</span><span class="token punctuation">(</span><span class="token string">"https://idp.example.com/.well-known/jwks.json"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Exemple Node (Express + jwks-rsa):</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token keyword module keyword-import">import</span> <span class="token imports">jwt</span> <span class="token keyword module keyword-from">from</span> <span class="token string">'express-jwt'</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token imports">jwks</span> <span class="token keyword module keyword-from">from</span> <span class="token string">'jwks-rsa'</span><span class="token punctuation">;</span>

<span class="token keyword module keyword-export">export</span> <span class="token keyword keyword-const">const</span> auth <span class="token operator">=</span> <span class="token function">jwt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	<span class="token literal-property property">secret</span><span class="token operator">:</span> jwks<span class="token punctuation">.</span><span class="token method function property-access">expressJwtSecret</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">jwksUri</span><span class="token operator">:</span> <span class="token string">'https://idp.example.com/.well-known/jwks.json'</span><span class="token punctuation">,</span> <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">cacheMaxEntries</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token literal-property property">cacheMaxAge</span><span class="token operator">:</span> <span class="token number">600000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token literal-property property">algorithms</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'RS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token literal-property property">audience</span><span class="token operator">:</span> <span class="token string">'api://micro'</span><span class="token punctuation">,</span>
	<span class="token literal-property property">issuer</span><span class="token operator">:</span> <span class="token string">'https://idp.example.com/'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">'/orders'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-const">const</span> roles <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token operator">?.</span>roles <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword control-flow keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>roles<span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span><span class="token string">'CUSTOMER'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword control-flow keyword-return">return</span> res<span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ... create order</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="service-à-service-machine-to-machine">Service-à-service (machine-to-machine) </h3>
<ul>
<li>Flux: Client Credentials (IdP) → access_token avec scopes <code>svc.inventory.read</code>, etc.</li>
<li>Courte durée de vie (5–10 min), pas de refresh; rotation client_secret; mTLS optionnel intra-cluster.</li>
</ul>
<h3 id="vérification-côté-check-in--webhooks">Vérification côté Check-in &amp; Webhooks </h3>
<ul>
<li>Check-in app: device binding + scope restreint <code>ticket.checkin</code>; offline access si besoin (tokens courts, renouvelés via BFF).</li>
<li>Webhooks entrants: signature HMAC (entête horodaté), rejouer max 5 min; vérifier <code>idempotency-key</code>.</li>
</ul>
<h3 id="journalisation--confidentialité">Journalisation &amp; confidentialité </h3>
<ul>
<li>Journaliser <code>sub</code>, <code>roles</code>, <code>scope</code>, <code>client_id</code>, <code>jti</code>, corrélation; masquer PII.</li>
<li>Éviter de stocker les tokens; conserver seulement hachés si nécessaire (liste de révocation courte durée).</li>
</ul>
<h2 id="modélisation-des-données">Modélisation des Données </h2>
<p>Conventions générales (PostgreSQL sauf mention contraire):</p>
<ul>
<li>Clés primaires: <code>uuid</code> (type <code>uuid</code>) généré côté service.</li>
<li>Colonnes communes: <code>created_at timestamptz</code>, <code>updated_at timestamptz</code>, <code>version int</code> (verrou optimiste).</li>
<li>Intégrité: clés étrangères avec <code>on delete restrict</code>; contraintes d’unicité pour règles critiques (sièges uniques, check-in unique).</li>
<li>Outbox par service: publication fiable d’événements.</li>
<li>Idempotency store pour endpoints sensibles (paiements, commandes).</li>
</ul>
<h3 id="event-service-agrégats-event-performance-pricingscheme">Event Service (Agrégats: Event, Performance, PricingScheme) </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> events <span class="token punctuation">(</span>
	event_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	owner_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	title <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	description <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-status">status</span> <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span><span class="token keyword keyword-status">status</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'draft'</span><span class="token punctuation">,</span><span class="token string">'published'</span><span class="token punctuation">,</span><span class="token string">'archived'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	updated_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	version <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> performances <span class="token punctuation">(</span>
	performance_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> events<span class="token punctuation">(</span>event_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	start_time timestamptz <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	venue_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	pricing_scheme_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	updated_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	version <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> pricing_schemes <span class="token punctuation">(</span>
	pricing_scheme_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> events<span class="token punctuation">(</span>event_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> price_categories <span class="token punctuation">(</span>
	pricing_scheme_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> pricing_schemes<span class="token punctuation">(</span>pricing_scheme_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	name <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	currency <span class="token keyword keyword-char">char</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	amount <span class="token keyword keyword-numeric">numeric</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span> <span class="token punctuation">(</span>pricing_scheme_id<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> event_outbox <span class="token punctuation">(</span>
	id bigserial <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	payload jsonb <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	published <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Bounded aggregate: <code>Event</code> agrège <code>Performance</code> et <code>PricingScheme</code> par références. <code>Event</code> est racine pour statut et publication.</p>
<h3 id="inventory-service-agrégats-venue-seatingplan-seat-inventorybucket">Inventory Service (Agrégats: Venue, SeatingPlan, Seat, InventoryBucket) </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> venues <span class="token punctuation">(</span>
	venue_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	name <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	address jsonb<span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> seating_plans <span class="token punctuation">(</span>
	seating_plan_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	venue_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> venues<span class="token punctuation">(</span>venue_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	name <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> seats <span class="token punctuation">(</span>
	seat_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	seating_plan_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> seating_plans<span class="token punctuation">(</span>seating_plan_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	section <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	row_label <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	number_label <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-unique">unique</span> <span class="token punctuation">(</span>seating_plan_id<span class="token punctuation">,</span> section<span class="token punctuation">,</span> row_label<span class="token punctuation">,</span> number_label<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> inventory_buckets <span class="token punctuation">(</span>
	bucket_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	seating_plan_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> seating_plans<span class="token punctuation">(</span>seating_plan_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	zone <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	capacity <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span>capacity <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-unique">unique</span> <span class="token punctuation">(</span>seating_plan_id<span class="token punctuation">,</span> zone<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- Allocation par performance (plan appliqué à une performance donnée)</span>
<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> seat_allocations <span class="token punctuation">(</span>
	performance_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	seat_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> seats<span class="token punctuation">(</span>seat_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	hold_active <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	hold_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	expires_at timestamptz<span class="token punctuation">,</span>
	<span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span> <span class="token punctuation">(</span>performance_id<span class="token punctuation">,</span> seat_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-constraint">constraint</span> unique_active_hold <span class="token keyword keyword-unique">unique</span> <span class="token punctuation">(</span>performance_id<span class="token punctuation">,</span> seat_id<span class="token punctuation">,</span> hold_active<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> bucket_allocations <span class="token punctuation">(</span>
	performance_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	bucket_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> inventory_buckets<span class="token punctuation">(</span>bucket_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	reserved <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
	capacity <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span> <span class="token punctuation">(</span>performance_id<span class="token punctuation">,</span> bucket_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-constraint">constraint</span> reserved_le_capacity <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span>reserved <span class="token operator">&lt;=</span> capacity<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> inventory_outbox <span class="token punctuation">(</span>
	id bigserial <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	payload jsonb <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	published <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Redis (clé/TTL):</p>
<ul>
<li><code>inv:hold:{holdId}</code> → <code>{ performanceId, seats:[...], buckets:[{bucketId, qty}], exp }</code> (TTL 5–15 min).</li>
<li><code>inv:avail:{performanceId}:{bucketId}</code> → compteur restant.</li>
</ul>
<h3 id="catalogue-service-read-models--opensearch">Catalogue Service (Read models / OpenSearch) </h3>
<p>Indices OpenSearch:</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
	<span class="token property">"index"</span><span class="token operator">:</span> <span class="token string">"catalog-events"</span><span class="token punctuation">,</span>
	<span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"eventId"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"standard"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token property">"description"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token property">"nextPerformance"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token property">"city"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><code>catalog-availability</code> (par performance/zone ou siège) stocke <code>remaining</code> comme entier; rafraîchi par événements Inventory.</p>
<h3 id="reservation-service-agrégat-reservation">Reservation Service (Agrégat: Reservation) </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> reservations <span class="token punctuation">(</span>
	reservation_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	customer_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-status">status</span> <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span><span class="token keyword keyword-status">status</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'pending'</span><span class="token punctuation">,</span><span class="token string">'confirmed'</span><span class="token punctuation">,</span><span class="token string">'cancelled'</span><span class="token punctuation">,</span><span class="token string">'expired'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	expires_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	updated_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	version <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> reservation_items <span class="token punctuation">(</span>
	reservation_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> reservations<span class="token punctuation">(</span>reservation_id<span class="token punctuation">)</span> <span class="token keyword keyword-on">on</span> <span class="token keyword keyword-delete">delete</span> <span class="token keyword keyword-cascade">cascade</span><span class="token punctuation">,</span>
	performance_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	seat_id uuid<span class="token punctuation">,</span>
	bucket_id uuid<span class="token punctuation">,</span>
	qty <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token number">1</span><span class="token punctuation">,</span>
	currency <span class="token keyword keyword-char">char</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	unit_amount <span class="token keyword keyword-numeric">numeric</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	hold_id uuid<span class="token punctuation">,</span>
	<span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span> <span class="token punctuation">(</span>reservation_id<span class="token punctuation">,</span> performance_id<span class="token punctuation">,</span> seat_id<span class="token punctuation">,</span> bucket_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-index">index</span> idx_resv_expires <span class="token keyword keyword-on">on</span> reservations<span class="token punctuation">(</span>expires_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> reservation_outbox <span class="token punctuation">(</span>
	id bigserial <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	payload jsonb <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	published <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Redis: <code>resv:hold:{reservationId}</code> miroir des holds Inventory pour expiration rapide.</p>
<h3 id="order-service-agrégat-order">Order Service (Agrégat: Order) </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> orders <span class="token punctuation">(</span>
	order_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	reservation_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	customer_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-status">status</span> <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span><span class="token keyword keyword-status">status</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'pending'</span><span class="token punctuation">,</span><span class="token string">'paid'</span><span class="token punctuation">,</span><span class="token string">'cancelled'</span><span class="token punctuation">,</span><span class="token string">'refunded'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	currency <span class="token keyword keyword-char">char</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	total_amount <span class="token keyword keyword-numeric">numeric</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	updated_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	version <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> order_outbox <span class="token punctuation">(</span>
	id bigserial <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	payload jsonb <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	published <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="payment-service-agrégat-payment">Payment Service (Agrégat: Payment) </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> payments <span class="token punctuation">(</span>
	payment_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	order_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-status">status</span> <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span><span class="token keyword keyword-status">status</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'requires_action'</span><span class="token punctuation">,</span><span class="token string">'processing'</span><span class="token punctuation">,</span><span class="token string">'captured'</span><span class="token punctuation">,</span><span class="token string">'failed'</span><span class="token punctuation">,</span><span class="token string">'refunded'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	currency <span class="token keyword keyword-char">char</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	amount <span class="token keyword keyword-numeric">numeric</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	provider <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	provider_ref <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	idempotency_key <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	updated_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	version <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-unique">unique</span> <span class="token punctuation">(</span>idempotency_key<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> refunds <span class="token punctuation">(</span>
	refund_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	payment_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> payments<span class="token punctuation">(</span>payment_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	amount <span class="token keyword keyword-numeric">numeric</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-status">status</span> <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span><span class="token keyword keyword-status">status</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'pending'</span><span class="token punctuation">,</span><span class="token string">'succeeded'</span><span class="token punctuation">,</span><span class="token string">'failed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> idempotency_keys <span class="token punctuation">(</span>
	<span class="token keyword keyword-key">key</span> <span class="token keyword keyword-text">text</span> <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	request_hash <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	response jsonb<span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> payment_outbox <span class="token punctuation">(</span>
	id bigserial <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	payload jsonb <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	published <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="ticketing-service-agrégats-ticket-checkin">Ticketing Service (Agrégats: Ticket, CheckIn) </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> tickets <span class="token punctuation">(</span>
	ticket_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	order_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	performance_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	seat_id uuid<span class="token punctuation">,</span>
	bucket_id uuid<span class="token punctuation">,</span>
	<span class="token keyword keyword-status">status</span> <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span><span class="token keyword keyword-status">status</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'valid'</span><span class="token punctuation">,</span><span class="token string">'revoked'</span><span class="token punctuation">,</span><span class="token string">'used'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	qr_payload <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	updated_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	version <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> checkins <span class="token punctuation">(</span>
	checkin_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	ticket_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> tickets<span class="token punctuation">(</span>ticket_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	scanned_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	device_id <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-unique">unique</span> <span class="token punctuation">(</span>ticket_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> ticketing_outbox <span class="token punctuation">(</span>
	id bigserial <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	payload jsonb <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	published <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Stockage objet: <code>tickets/{ticketId}.pdf</code> (bucket S3/compatible) référencé depuis <code>tickets</code> si PDF généré.</p>
<h3 id="notification-service-1">Notification Service </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> templates <span class="token punctuation">(</span>
	template_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	name <span class="token keyword keyword-text">text</span> <span class="token keyword keyword-unique">unique</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	subject <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	body <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> notification_outbox <span class="token punctuation">(</span>
	id bigserial <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	payload jsonb <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	published <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="avis-service-reviews-1">Avis Service (Reviews) </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> reviews <span class="token punctuation">(</span>
	review_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	author_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	target_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span>target_type <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">,</span><span class="token string">'performance'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	target_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	rating <span class="token keyword keyword-int">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span>rating <span class="token operator">between</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-comment">comment</span> <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-status">status</span> <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span><span class="token keyword keyword-status">status</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'published'</span><span class="token punctuation">,</span><span class="token string">'deleted'</span><span class="token punctuation">,</span><span class="token string">'flagged'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	updated_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-unique">unique</span> <span class="token keyword keyword-index">index</span> uniq_review_author_target <span class="token keyword keyword-on">on</span> reviews<span class="token punctuation">(</span>author_id<span class="token punctuation">,</span> target_type<span class="token punctuation">,</span> target_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> review_flags <span class="token punctuation">(</span>
	flag_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	review_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> reviews<span class="token punctuation">(</span>review_id<span class="token punctuation">)</span> <span class="token keyword keyword-on">on</span> <span class="token keyword keyword-delete">delete</span> <span class="token keyword keyword-cascade">cascade</span><span class="token punctuation">,</span>
	flagged_by uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	reason <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> reviews_outbox <span class="token punctuation">(</span>
	id bigserial <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	payload jsonb <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	published <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="support-service-support-client">Support Service (Support Client) </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> support_tickets <span class="token punctuation">(</span>
	ticket_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	customer_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	subject <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	description <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	<span class="token keyword keyword-status">status</span> <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-check">check</span> <span class="token punctuation">(</span><span class="token keyword keyword-status">status</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span><span class="token string">'in_progress'</span><span class="token punctuation">,</span><span class="token string">'closed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	order_id uuid<span class="token punctuation">,</span>
	payment_id uuid<span class="token punctuation">,</span>
	ticket_ref <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	updated_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> support_messages <span class="token punctuation">(</span>
	message_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	ticket_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-references">references</span> support_tickets<span class="token punctuation">(</span>ticket_id<span class="token punctuation">)</span> <span class="token keyword keyword-on">on</span> <span class="token keyword keyword-delete">delete</span> <span class="token keyword keyword-cascade">cascade</span><span class="token punctuation">,</span>
	sender_id uuid <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	message <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> support_outbox <span class="token punctuation">(</span>
	id bigserial <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	event_type <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	payload jsonb <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	published <span class="token keyword keyword-boolean">boolean</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="customer--identity-optionnel-interne">Customer / Identity (optionnel interne) </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token keyword keyword-create">create</span> <span class="token keyword keyword-table">table</span> customers <span class="token punctuation">(</span>
	customer_id uuid <span class="token keyword keyword-primary">primary</span> <span class="token keyword keyword-key">key</span><span class="token punctuation">,</span>
	email <span class="token keyword keyword-text">text</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-unique">unique</span><span class="token punctuation">,</span>
	name <span class="token keyword keyword-text">text</span><span class="token punctuation">,</span>
	created_at timestamptz <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword keyword-default">default</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="mapping-ddd-synthèse">Mapping DDD (Synthèse) </h3>
<ul>
<li>Event: racine <code>Event</code> → <code>events</code>; entités <code>Performance</code> → <code>performances</code>; <code>PricingScheme</code> + <code>price_categories</code>.</li>
<li>Inventory: racine <code>SeatingPlan</code> → <code>seating_plans</code> avec <code>seats</code> et <code>inventory_buckets</code>; allocations par performance (<code>seat_allocations</code>, <code>bucket_allocations</code>).</li>
<li>Reservation: racine <code>Reservation</code> → <code>reservations</code> avec <code>reservation_items</code>.</li>
<li>Order: racine <code>Order</code> → <code>orders</code>.</li>
<li>Payment: racine <code>Payment</code> → <code>payments</code>, <code>refunds</code>, <code>idempotency_keys</code>.</li>
<li>Ticketing: racine <code>Ticket</code> → <code>tickets</code>; <code>CheckIn</code> → <code>checkins</code>.</li>
<li>Read models: Catalogue en OpenSearch; pas de jointures cross-service.</li>
</ul>
<hr>
<h2 id="synthèse-des-décisions-adr">Synthèse des Décisions (ADR) </h2>
<ul>
<li>Architecture: microservices guidés par DDD, échanges par événements; lecture Catalogue séparée.</li>
<li>Messages: RabbitMQ (exchange <code>domain.events</code>), clés simples <code>&lt;service&gt;.&lt;entité&gt;.&lt;événement&gt;</code>, files de retry et DLQ.</li>
<li>Cohérence: pas de transactions distribuées; on utilise des Sagas et l’Outbox; les consommateurs sont idempotents.</li>
<li>Données: une base PostgreSQL par service; Redis pour les expirations et compteurs; OpenSearch pour le catalogue.</li>
<li>Sécurité: OIDC/OAuth2 pour les utilisateurs et les services; rôles + attributs; vérification JWT à la Gateway et dans les services.</li>
<li>Résilience: délais et retries raisonnables; circuit breakers sur les appels synchrones avec règles simples.</li>
<li>Observabilité: traces (OpenTelemetry), métriques et logs JSON avec un identifiant de corrélation.</li>
<li>Déploiement: Dev (Compose), Staging/Prod (Kubernetes/Helm); images signées et SBOM; déploiements par tags.</li>
</ul>
<hr>
<h2 id="risques--atténuations">Risques &amp; Atténuations </h2>
<ul>
<li>Charge élevée sur Inventory/Reservation: Redis pour les réservations temporaires, circuit breaker et montée en charge horizontale.</li>
<li>Dépendance au PSP: circuit breaker + délais courts, webhooks de secours et tâche de réconciliation.</li>
<li>Messages perdus ou bloquants: DLQ par queue, alertes, procédure de reprise; idempotence partout.</li>
<li>Évolution des schémas d’événements: versions de JSON Schema, compatibilité ascendante, tests de contrat.</li>
<li>Sécurité des jetons: rotation des refresh tokens, cache JWKS, scopes précis; mTLS possible en interne.</li>
<li>Tests E2E instables: mise en quarantaine, retries limités; observabilité pour diagnostiquer rapidement.</li>
</ul>
<hr>
<h2 id="éléments-ouverts--à-valider">Éléments Ouverts / À Valider </h2>
<ul>
<li>Points du PDF à confirmer: PSP imposé, SLA/SLO, nombre minimal/maximal de services, outils obligatoires.</li>
<li>Annulation/remboursement: fenêtres, frais, et cas d’événement annulé (détail à fixer).</li>
<li>Check‑in offline: si demandé, préciser les limites et protections anti‑fraude.</li>
<li>Gateway/IdP: choix final (Kong/Envoy/Traefik, Keycloak/Auth0) selon consigne.</li>
</ul>
<hr>
<h2 id="glossaire">Glossaire </h2>
<ul>
<li>Saga: suite d’étapes distribuées avec actions de compensation en cas d’échec.</li>
<li>Outbox: table locale où le service écrit ses événements avant publication.</li>
<li>DLQ: file pour les messages qui n’ont pas pu être traités.</li>
<li>RBAC/ABAC: autorisation par rôles et par attributs (ex. propriétaire).</li>
<li>Correlation ID: identifiant unique pour relier les logs et les traces.</li>
</ul>
<hr>
<h2 id="traçabilité">Traçabilité </h2>
<ul>
<li>Domaine &amp; DDD → Section "Analyse du Domaine &amp; DDD".</li>
<li>Microservices &amp; Données → Sections "Décomposition", "Modélisation des Données".</li>
<li>APIs &amp; Contrats → "Spécification des APIs", "Modélisation des Événements".</li>
<li>Cohérence &amp; Sagas → "Stratégie de Cohérence", "Conception des Sagas &amp; Circuit Breakers".</li>
<li>Sécurité → "Conception de la Sécurité — Détails Auth &amp; Rôles".</li>
<li>Déploiement → "Plan de Déploiement &amp; CI/CD".</li>
<li>Tests &amp; Observabilité → "Plan de Tests &amp; Observabilité".</li>
</ul>
<hr>
<h2 id="plan-dimplémentation-feuille-de-route">Plan d’Implémentation (Feuille de Route) </h2>
<p>Objectif: livrer un parcours vertical « Réserver → Payer → Billets → Check‑in » fiable et observable, puis élargir (Catalogue, back‑office), avec qualité et sécurité intégrées.</p>
<h3 id="rôles--répartition-proposés">Rôles &amp; Répartition (proposés) </h3>
<ul>
<li>Lead/Architecte: gouvernance DDD, ADR, cohérence transverse, revues.</li>
<li>Backend‑A: Reservation &amp; Order.</li>
<li>Backend‑B: Inventory &amp; Ticketing.</li>
<li>Backend‑C: Payment &amp; Notification (PSP, webhooks, idempotence).</li>
<li>Frontend: UI client (réservation/paiement/billets), back‑office minimal.</li>
<li>DevOps/QA: CI/CD, K8s/Helm, observabilité, tests E2E/contrats.</li>
</ul>
<p>Adapter ces rôles aux membres réels; un membre peut cumuler plusieurs rôles si équipe réduite.</p>
<h3 id="jalons--calendrier-proposés">Jalons &amp; Calendrier (proposés) </h3>
<ul>
<li>M0 — Kickoff &amp; exigences PDF validées: 2025‑12‑02</li>
<li>M1 — Fondations (repo, CI, IdP, Gateway, skeleton services): 2025‑12‑05</li>
<li>M2 — Vertical Slice v1 (happy path Réserver→Payer→Billets): 2025‑12‑12</li>
<li>M3 — Résilience &amp; Sécurité (CB/Retry/DLQ, JWT end‑to‑end): 2025‑12‑19</li>
<li>M4 — Observabilité &amp; Catalogue (search/read models) + E2E: 2025‑12‑30</li>
<li>M5 — RC1 performance + documentation blueprint: 2026‑01‑09</li>
</ul>
<p>Note: semaines de fin d’année comportent des jours fériés; plan intégré avec buffer.</p>
<h3 id="timeline-gantt--indicatif">Timeline (Gantt — indicatif) </h3>
<div class="mermaid">gantt
	title Roadmap Implémentation (2025-12-01 → 2026-01-09)
	dateFormat  YYYY-MM-DD
	section Gouvernance
	M0:active, m0, 2025-12-01, 2d
	ADR/Schémas: m0a, 2025-12-03, 3d
	section Fondations
	Repo/CI/Images: m1a, 2025-12-01, 5d
	IdP/Gateway: m1b, 2025-12-03, 3d
	section Vertical Slice
	Reservation+Inventory (sync): m2a, 2025-12-08, 3d
	Order+Payment (capture/webhook): m2b, 2025-12-10, 3d
	Ticketing (issue): m2c, 2025-12-11, 2d
	section Résilience &amp; Sécurité
	Outbox/Idempotence/CB: m3a, 2025-12-15, 3d
	JWT E2E &amp; ABAC: m3b, 2025-12-17, 2d
	section Observabilité &amp; Catalogue
	OTEL/Metrics/Logs: m4a, 2025-12-22, 3d
	Catalogue Read/Search: m4b, 2025-12-26, 3d
	section Finalisation
	E2E/Perf/RC1: m5a, 2026-01-02, 5d
</div><h3 id="découpage-des-tâches-principales">Découpage des tâches (principales) </h3>
<ul>
<li>Fondations
<ul>
<li>Monorepo ou multi‑repos; conventions; templates Dockerfiles; modules communs (DTO/erreurs).</li>
<li>CI: jobs « test », « build+push », « scan », « deploy‑staging »; registry configuré; SBOM + signature.</li>
<li>IdP (Keycloak) + Gateway (Envoy/Kong) en dev; JWKS cache, routes initiales.</li>
</ul>
</li>
<li>Vertical Slice v1
<ul>
<li>Reservation: <code>POST /reservations</code>, <code>items</code>, <code>confirm</code> (+ appel sync Inventory Reserve/Release).</li>
<li>Inventory: <code>POST /inventory/holds</code>, TTL, unique constraints, <code>Release</code>.</li>
<li>Order/Payment: <code>POST /orders</code>, <code>payments/intents</code> (capture ou webhook), idempotency‑key.</li>
<li>Ticketing: <code>POST /tickets/issue</code> sur <code>order.paid</code> (consume event).</li>
<li>Notification: stub sur <code>ticket.issued</code>.</li>
</ul>
</li>
<li>Résilience &amp; Sécurité
<ul>
<li>Outbox par service; <code>processed_events</code>; retries + DLQ par queue; CB/timeouts configurés (Resilience4j).</li>
<li>JWT validation Gateway + Services; RBAC/ABAC; scopes par route; webhooks signés.</li>
</ul>
</li>
<li>Observabilité &amp; Catalogue
<ul>
<li>OTEL tracer + Collector; RED/USE dashboards; logs JSON corrélés.</li>
<li>Catalogue indexation (OpenSearch) et endpoints <code>GET /catalog/*</code>.</li>
</ul>
</li>
<li>Finalisation
<ul>
<li>E2E Playwright (réserver→payer→billets, annuler→rembourser), tests charge (k6).</li>
<li>Perf tuning (DB indexes, pool connexions), RC1; documentation finale.</li>
</ul>
</li>
</ul>
<h3 id="raci-extrait">RACI (extrait) </h3>
<ul>
<li>ADR &amp; DDD: R(Lead), A(Lead), C(Backend‑A/B/C), I(Frontend, DevOps)</li>
<li>CI/CD &amp; K8s: R(DevOps), A(Lead), C(Backend‑A/B/C), I(Frontend)</li>
<li>Reservation/Order: R(Backend‑A), A(Lead), C(Backend‑B/C), I(DevOps)</li>
<li>Inventory/Ticketing: R(Backend‑B), A(Lead), C(Backend‑A), I(DevOps)</li>
<li>Payment/PSP: R(Backend‑C), A(Lead), C(Backend‑A), I(DevOps)</li>
<li>Frontend: R(Frontend), A(Lead), C(Backends), I(DevOps)</li>
</ul>
<h3 id="dépendances--chemin-critique">Dépendances &amp; Chemin critique </h3>
<ul>
<li>Inventory « Reserve/Release » prêt avant Reservation « confirm ».</li>
<li>Payment capture/webhook prêt avant Order « paid » et Ticketing « issue ».</li>
<li>Outbox/Idempotence/CB avant E2E de fiabilité.</li>
</ul>
<h3 id="définition-de-fini-dod">Définition de Fini (DoD) </h3>
<ul>
<li>Tests unitaires ≥ 80% (core ≥ 90%), contrats validés, E2E clé verts.</li>
<li>Lint/type‑check propres; images signées + SBOM; healthchecks OK.</li>
<li>Traces/métriques/logs présents; dashboards RED/USE publies; alertes basiques.</li>
<li>Sécurité: validation JWT, RBAC/ABAC, secrets hors code, webhooks signés.</li>
</ul>
<h3 id="communication--cérémonies">Communication &amp; Cérémonies </h3>
<ul>
<li>Stand‑up 15 min/j; revues code systématiques; demo hebdomadaire.</li>
<li>Board (GitHub Projects/Jira): colonnes Backlog → In Progress → Review → Done; étiquettes par service.</li>
</ul>
<h3 id="risques--buffers">Risques &amp; Buffers </h3>
<ul>
<li>Congés fin d’année: buffer intégré semaines 52–01.</li>
<li>PSP instable: fallback webhook + réconciliation; tests sur sandbox tôt.</li>
<li>Flaky E2E: quarantine, retries limités; logs/trace pour RCA rapide.</li>
</ul>
<hr>
<h2 id="plan-de-tests--observabilité">Plan de Tests &amp; Observabilité </h2>
<p>Cette section décrit la pyramide de tests (unitaires → E2E) et le plan d’observabilité (métriques, logs, traces), avec propagation systématique d’un identifiant de corrélation.</p>
<h3 id="pyramide-de-tests">Pyramide de Tests </h3>
<div class="mermaid">flowchart TD
	A[Unitaires 70%+] --&gt; B[Intégration 20%]
	B --&gt; C[Contrats 5-10%]
	C --&gt; D[E2E 5%]
</div><ul>
<li>Unitaires:
<ul>
<li>Ciblent entités/VO/domain services; aucun IO. Mocks/stubs aux frontières.</li>
<li>Seuils: 80% lignes/branches global; 95% sur noyau domaine critique.</li>
<li>Mutation testing (ex. PIT/JVM, Stryker/JS): taux de « kills » ≥ 60% sur domaine.</li>
</ul>
</li>
<li>Intégration:
<ul>
<li>Repositories/ORM sur base réelle éphémère (Testcontainers Postgres/Redis/RabbitMQ).</li>
<li>Tests HTTP contrôleurs (sans UI), sérialisation DTO, idempotence/outbox.</li>
<li>Inclure scénarios de retries/DLQ et cohérence des transactions locales.</li>
</ul>
</li>
<li>Contrats (synchro &amp; asynchro):
<ul>
<li>Consumer-driven contracts (Pact) pour REST; publication vers un Pact Broker et vérification côté provider en CI.</li>
<li>Événements: contrats de messages (Pact messages) + validation JSON Schema; versionnage de schémas.</li>
<li>Gate CI: échec si contrat cassé ou schéma non compatible.</li>
</ul>
</li>
<li>E2E (parcours clés):
<ul>
<li>Parcours: « réserver → payer → billets → check-in » et « annuler → rembourser ».</li>
<li>Outils: Playwright/Cypress; environnements: Staging (données synthétiques). Nettoyage de données par tenant.</li>
<li>Budget minimal, stabilité &gt; 99% (flaky test quarantine + replays limités).</li>
</ul>
</li>
</ul>
<p>CI/CD &amp; Qualité:</p>
<ul>
<li>Ordre d’exécution: Unit → Intégration → Contrats → (sur <code>main</code>) E2E.</li>
<li>Seuils de couverture: 80% global; 90% packages core; mutation sur domaine.</li>
<li>Gates: contrats validés, migrations DB testées, images démarrables (healthcheck OK), lint/type-check sans erreurs.</li>
<li>Artefacts: rapports JUnit, coverage (LCOV/Jacoco), Pact, vidéos/screenshots E2E.</li>
</ul>
<p>Gestion des données de test:</p>
<ul>
<li>Factories/fixtures déterministes; seed par tenant <code>test</code>.</li>
<li>Jamais de PII réelle; générateurs (Faker) et masquage.</li>
<li>Identifiants stables pour assertions (idempotency-key, correlation-id).</li>
</ul>
<h3 id="observabilité-métriques-logs-traces">Observabilité (Métriques, Logs, Traces) </h3>
<p>Objectifs:</p>
<ul>
<li>Déboguer rapidement les parcours utilisateurs et les sagas.</li>
<li>Surveiller SLO/SLI et détecter régressions (latence, erreurs, saturation).</li>
</ul>
<p>Identifiant de corrélation:</p>
<ul>
<li>Généré à la Gateway si absent: <code>x-correlation-id</code> (UUID v4) et W3C Trace Context <code>traceparent</code>.</li>
<li>Propagation inter-services: entêtes HTTP (<code>x-correlation-id</code>, <code>traceparent</code>, <code>tracestate</code>).</li>
<li>Événements: inclure dans en-têtes message et/ou enveloppe CloudEvents (<code>correlationid</code> extension) et <code>traceparent</code>.</li>
<li>Persistance: colonnes <code>correlation_id</code> dans <code>outbox</code>, <code>processed_events</code>, <code>orders</code> (optionnel) pour investigations.</li>
</ul>
<p>Métriques:</p>
<ul>
<li>RED (par service):
<ul>
<li>Rate: requêtes/s, événements/s.</li>
<li>Errors: taux 4xx/5xx, échecs saga/compensation.</li>
<li>Duration: p50/p95/p99 par endpoint et par appel externe (Inventory, PSP).</li>
</ul>
</li>
<li>USE (infra): utilisation CPU/mémoire, saturation pool connexions/threads, erreurs.</li>
<li>Métier:
<ul>
<li>Réservations créées, taux de conversion paiement, délais émission billets, check-ins/h.</li>
<li>Stock restant par event/performance, taux d’abandon panier.</li>
</ul>
</li>
<li>SLO/SLI exemples:
<ul>
<li>99% <code>POST /orders</code> &lt; 300 ms; 99.5% <code>GET /catalog/**</code> &lt; 200 ms.</li>
<li>Taux succès paiements ≥ 98% (fenêtre 30 min).</li>
<li>Disponibilité API Gateway ≥ 99.9% mensuelle.</li>
</ul>
</li>
<li>Alerting:
<ul>
<li>Burn rate SLO multi-fenêtres (ex. 2%/1h, 0.5%/6h).</li>
<li>Erreurs 5xx &gt; 2%/5min, latence p95 &gt; SLO+20%, CB ouvert &gt; 2 min.</li>
</ul>
</li>
</ul>
<p>Logs (structurés JSON):</p>
<ul>
<li>Champs minimaux: <code>ts</code>, <code>level</code>, <code>service</code>, <code>env</code>, <code>traceId</code>, <code>spanId</code>, <code>correlationId</code>, <code>requestId</code>, <code>userId</code> (si dispo), <code>route</code>, <code>status</code>, <code>durationMs</code>, <code>msg</code>.</li>
<li>Masquer PII (emails, cartes); limiter volume (rate limit sur erreurs bavardes).</li>
<li>Exemple:</li>
</ul>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span><span class="token property">"ts"</span><span class="token operator">:</span><span class="token string">"2025-11-29T10:21:34.123Z"</span><span class="token punctuation">,</span><span class="token property">"level"</span><span class="token operator">:</span><span class="token string">"INFO"</span><span class="token punctuation">,</span><span class="token property">"service"</span><span class="token operator">:</span><span class="token string">"orders"</span><span class="token punctuation">,</span><span class="token property">"env"</span><span class="token operator">:</span><span class="token string">"stg"</span><span class="token punctuation">,</span><span class="token property">"traceId"</span><span class="token operator">:</span><span class="token string">"4f3..."</span><span class="token punctuation">,</span><span class="token property">"spanId"</span><span class="token operator">:</span><span class="token string">"b12..."</span><span class="token punctuation">,</span><span class="token property">"correlationId"</span><span class="token operator">:</span><span class="token string">"7a1e-..."</span><span class="token punctuation">,</span><span class="token property">"route"</span><span class="token operator">:</span><span class="token string">"POST /orders"</span><span class="token punctuation">,</span><span class="token property">"status"</span><span class="token operator">:</span><span class="token number">201</span><span class="token punctuation">,</span><span class="token property">"durationMs"</span><span class="token operator">:</span><span class="token number">124</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span><span class="token string">"order.created"</span><span class="token punctuation">,</span><span class="token property">"orderId"</span><span class="token operator">:</span><span class="token string">"ord_123"</span><span class="token punctuation">}</span>
</code></pre><p>Traces distribuées (OpenTelemetry):</p>
<ul>
<li>Instrumentation serveur/clients HTTP et messaging; liens entre spans synchro et asynchrones (span links sur événements).</li>
<li>Échantillonnage: 10% head-based; always-on sur erreurs/CB ouverts.</li>
<li>Export OTLP → OpenTelemetry Collector → Jaeger/Tempo; corrélation logs↔traces via <code>traceId</code>.</li>
</ul>
<p>Propagation &amp; intégration:</p>
<ul>
<li>Gateway: injecte/valide <code>x-correlation-id</code> + <code>traceparent</code>; ajoute <code>x-correlation-id</code> si absent.</li>
<li>Services: extraire et mettre en MDC (JVM) / CLS (Node) pour logs; réinjecter sur appels sortants.</li>
<li>Messages: ajouter headers <code>x-correlation-id</code>, <code>traceparent</code>; stocker dans outbox.</li>
</ul>
<p>Exemples de configuration</p>
<ul>
<li>Spring Boot (OTEL):</li>
</ul>
<pre data-role="codeBlock" data-info="properties" class="language-properties properties"><code><span class="token key attr-name">management.tracing.propagation.type</span><span class="token punctuation">=</span><span class="token value attr-value">w3c</span>
<span class="token key attr-name">management.otlp.tracing.endpoint</span><span class="token punctuation">=</span><span class="token value attr-value">http://otel-collector:4317</span>
<span class="token key attr-name">management.tracing.sampling.probability</span><span class="token punctuation">=</span><span class="token value attr-value">0.1</span>
<span class="token key attr-name">logging.pattern.level</span><span class="token punctuation">=</span><span class="token value attr-value">%5p [%X{traceId:-} %X{spanId:-} %X{correlationId:-}]</span>
</code></pre><ul>
<li>Node.js (OTEL):</li>
</ul>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token keyword module keyword-import">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">NodeSDK</span> <span class="token punctuation">}</span></span> <span class="token keyword module keyword-from">from</span> <span class="token string">'@opentelemetry/sdk-node'</span><span class="token punctuation">;</span>
<span class="token keyword module keyword-import">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">OTLPTraceExporter</span> <span class="token punctuation">}</span></span> <span class="token keyword module keyword-from">from</span> <span class="token string">'@opentelemetry/exporter-trace-otlp-grpc'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> sdk <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">NodeSDK</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">traceExporter</span><span class="token operator">:</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">OTLPTraceExporter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://otel-collector:4317'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sdk<span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Tableaux de bord &amp; alertes:</p>
<ul>
<li>Grafana: tableaux RED/USE par service, funnel métier (réservation→paiement→billets), état des CB.</li>
<li>Alertes: Pager sur SLO burn, erreurs DLQ croissantes, taux refund anormal.</li>
</ul>
<p>Sécurité &amp; conformité:</p>
<ul>
<li>Pas de PII/secrets dans logs; retention différenciée (erreurs plus courte).</li>
<li>Accès observabilité contrôlé par rôles; données tracées chiffrées en transit.</li>
</ul>

      </div>
      
      
    
    
    <script type="module">
// TODO: If ZenUML gets integrated into mermaid in the future,
//      we can remove the following lines.


var MERMAID_CONFIG = ({"startOnLoad":false});
if (typeof MERMAID_CONFIG !== 'undefined') {
  MERMAID_CONFIG.startOnLoad = false
  MERMAID_CONFIG.cloneCssStyles = false
  MERMAID_CONFIG.theme = "default"
}

mermaid.initialize(MERMAID_CONFIG || {})
if (typeof(window['Reveal']) !== 'undefined') {
  function mermaidRevealHelper(event) {
    var currentSlide = event.currentSlide
    var diagrams = currentSlide.querySelectorAll('.mermaid')
    for (var i = 0; i < diagrams.length; i++) {
      var diagram = diagrams[i]
      if (!diagram.hasAttribute('data-processed')) {
        mermaid.init(null, diagram, ()=> {
          Reveal.slide(event.indexh, event.indexv)
        })
      }
    }
  }
  Reveal.addEventListener('slidetransitionend', mermaidRevealHelper)
  Reveal.addEventListener('ready', mermaidRevealHelper)
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
} else {
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
}
</script>
    
    
    
  
    </body></html>